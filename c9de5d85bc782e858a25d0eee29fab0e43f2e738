{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "37942f39_6eabc90c",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 13
      },
      "lineNbr": 0,
      "author": {
        "id": 671
      },
      "writtenOn": "2022-07-28T09:13:31Z",
      "side": 1,
      "message": "I have raised this in one of my previous comments[0] that these changes degrade the user experience of CLI users(thank you for patch[1] that improves the situation and now that we don\u0027t have to download job-output.txt). But on average this change still increases the time to get results from 3 times to 10 times. Please check pastebin[2] with the new code it took 10x time on my local machine.\n\nold code: ~30 s on average\nnew code: 1 to 4 mins on average\n\nThe increase in time is mostly because now we are doing more things which we only utilize for the dashboard and don\u0027t utilize at all for the client users, ex:-\n\n* We download the failure file download (find_failure_reason).\n* We find the duration for which the job ran.\n\nThese changes have a lot of future improvement potential for example We can start showing failure_reason/duration for which failing job ran on CLI, But Imho. We should not do that by default as that is expensive in terms of the time it takes. So maybe as a possible solution, we skip check duration/find_failure_reason when we run the script without --influx flag.\n\n\n[0] https://review.rdoproject.org/r/c/rdo-infra/ci-config/+/43161/13#message-f778aa5106137ac38da038cecea919bde7f2fbc9\n[1] https://review.rdoproject.org/r/c/rdo-infra/ci-config/+/43303/\n[2] https://paste.openstack.org/show/bXEcPNwh4VIILjqBymXK/",
      "revId": "c9de5d85bc782e858a25d0eee29fab0e43f2e738",
      "serverId": "270e2033-b340-4cff-9539-693957ebf0e7"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1751251c_10020af8",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 13
      },
      "lineNbr": 0,
      "author": {
        "id": 671
      },
      "writtenOn": "2022-07-28T09:28:07Z",
      "side": 1,
      "message": "I meant something like below:-\n\n\n~~~\n-def prepare_jobs(jobs_in_criteria, dlrn_jobs):\n+def prepare_jobs(jobs_in_criteria, dlrn_jobs, influx\u003dFalse):\n     \"\"\"\n     InfluxDB follows line protocol [1]\n \n@@ -490,7 +490,6 @@ def prepare_jobs(jobs_in_criteria, dlrn_jobs):\n     :param dlrn_jobs (set): Jobs, registered by DLRN.\n     :return job_result_list (list of dicts): List of parsed jobs.\n     \"\"\"\n-\n     logging.debug(\"Preparing influxdb\")\n \n     all_jobs \u003d set(dlrn_jobs).union(jobs_in_criteria)\n@@ -508,21 +507,24 @@ def prepare_jobs(jobs_in_criteria, dlrn_jobs):\n \n         # NOTE(dasm): DLRN returns job.url without trailing \u0027/\u0027\n         log_url \u003d job.url + \u0027/\u0027 if job else \"N/A\"\n-        zuul_job \u003d zuul_jobs.get(log_url)\n-        if not zuul_job:\n-            logging.error(\"Missing job %s\", log_url)\n-            zuul_job \u003d {}\n-\n-        d \u003d zuul_job.get(\u0027duration\u0027, 0)\n-        duration \u003d time.strftime(\"%H hr %M mins %S secs\", time.gmtime(d))\n+        if influx:\n+            zuul_job \u003d zuul_jobs.get(log_url)\n+            if not zuul_job:\n+                logging.error(\"Missing job %s\", log_url)\n+                zuul_job \u003d {}\n+            d \u003d zuul_job.get(\u0027duration\u0027, 0)\n+            duration \u003d time.strftime(\"%H hr %M mins %S secs\", time.gmtime(d))\n+            reason \u003d (find_failure_reason(log_url) if status \u003d\u003d INFLUX_FAILED else \"N/A\")\n+        else:\n+            duration \u003d \"N/A\"\n+            reason \u003d \"N/A\"\n         job_result \u003d {\n             \u0027job_name\u0027: job_name,\n             \u0027criteria\u0027: job_name in jobs_in_criteria,\n             \u0027logs\u0027: log_url,\n             \u0027duration\u0027: duration,\n             \u0027status\u0027: status,\n-            \u0027failure_reason\u0027: (find_failure_reason(log_url)\n-                               if status \u003d\u003d INFLUX_FAILED else \"N/A\"),\n+            \u0027failure_reason\u0027: reason\n         }\n         job_result_list.append(job_result)\n     logging.debug(\"Prepared influxdb: %s\", job_result_list)\n\n~~~",
      "parentUuid": "37942f39_6eabc90c",
      "revId": "c9de5d85bc782e858a25d0eee29fab0e43f2e738",
      "serverId": "270e2033-b340-4cff-9539-693957ebf0e7"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3208fc19_96648d3d",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 13
      },
      "lineNbr": 0,
      "author": {
        "id": 756
      },
      "writtenOn": "2022-07-28T13:11:49Z",
      "side": 1,
      "message": "Hey Sandeep. I was running tests on my setup with regards to time execution. There were variations not more than several seconds. Running on the same configuration distro and release, I was sometimes seeing improvement in test execution and sometimes degrade in that.\nBut never it took 3-10 times longer.\n\nIt\u0027s actually quicker than your test: https://paste.openstack.org/show/bMyxGXtssP5HAb3kaxgH/\n\u003e real\t0m17.226s",
      "parentUuid": "1751251c_10020af8",
      "revId": "c9de5d85bc782e858a25d0eee29fab0e43f2e738",
      "serverId": "270e2033-b340-4cff-9539-693957ebf0e7"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "23d25b29_10d51bff",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 13
      },
      "lineNbr": 0,
      "author": {
        "id": 756
      },
      "writtenOn": "2022-07-28T13:31:29Z",
      "side": 1,
      "message": "I\u0027m trying to avoid branching fetching data even more. That\u0027s why I removed \"influx\".\nWrt time spent fetching those logs:\n\u003e \n2022-07-28 06:10:30 -\u003e 2022-07-28 06:10:36\n\nAs a follow-up discussion on IRC, it seems that logserver might be located in the USA, hence people from differet areas might see huge delays.",
      "parentUuid": "3208fc19_96648d3d",
      "revId": "c9de5d85bc782e858a25d0eee29fab0e43f2e738",
      "serverId": "270e2033-b340-4cff-9539-693957ebf0e7"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "40adf103_1eea0098",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 13
      },
      "lineNbr": 0,
      "author": {
        "id": 756
      },
      "writtenOn": "2022-07-28T17:17:43Z",
      "side": 1,
      "message": "Sandeep, please give it a try. I reworked the way how files are being downloaded. I hope it\u0027s gonna be faster on your side.",
      "parentUuid": "23d25b29_10d51bff",
      "revId": "c9de5d85bc782e858a25d0eee29fab0e43f2e738",
      "serverId": "270e2033-b340-4cff-9539-693957ebf0e7"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f73803f0_c9c65faa",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 13
      },
      "lineNbr": 0,
      "author": {
        "id": 671
      },
      "writtenOn": "2022-07-29T02:59:12Z",
      "side": 1,
      "message": "http://pastebin.test.redhat.com/1068548 still taking more than 2 mins for me.\n\nIn the above pastebin example:-\n\nfailures_file was not present in any of the jobs, so there was nothing to download, so downloading part didn\u0027t take time.\n~~~\n2022-07-29 07:50:28,948:DEBUG - prepare_jobs:496 Parsing jobs\n2022-07-29 07:50:28,948:DEBUG - find_failure_reason:83 Fetch failure reason: https://logserver.rdoproject.org/openstack-component-common/opendev.org/openstack/tripleo-ci/master/periodic-tripleo-ci-centos-9-containers-multinode-common-master/b0ca5b3/logs/failures_file\n2022-07-29 07:50:30,532:DEBUG - find_failure_reason:94 Failed fetching reason\n2022-07-29 07:50:30,532:DEBUG - find_failure_reason:83 Fetch failure reason: https://logserver.rdoproject.org/openstack-component-common/opendev.org/openstack/tripleo-ci/master/periodic-tripleo-ci-centos-9-scenario000-multinode-oooq-container-updates-common-master/0b4495b/logs/failures_file\n2022-07-29 07:50:31,830:DEBUG - find_failure_reason:94 Failed fetching reason\n2022-07-29 07:50:31,831:DEBUG - find_failure_reason:83 Fetch failure reason: https://logserver.rdoproject.org/openstack-component-common/opendev.org/openstack/tripleo-ci/master/periodic-tripleo-ci-centos-9-scenario001-standalone-common-master/19b959e/logs/failures_file\n2022-07-29 07:50:33,005:DEBUG - find_failure_reason:94 Failed fetching reason\n2022-07-29 07:50:33,005:DEBUG - find_failure_reason:83 Fetch failure reason: https://logserver.rdoproject.org/openstack-component-common/opendev.org/openstack/tripleo-ci/master/periodic-tripleo-ci-centos-9-scenario002-standalone-common-master/d2c5041/logs/failures_file\n2022-07-29 07:50:34,262:DEBUG - find_failure_reason:94 Failed fetching reason\n2022-07-29 07:50:34,263:DEBUG - find_failure_reason:83 Fetch failure reason: https://logserver.rdoproject.org/openstack-component-common/opendev.org/openstack/tripleo-ci/master/periodic-tripleo-ci-centos-9-scenario003-standalone-common-master/8cde57b/logs/failures_file\n2022-07-29 07:50:35,514:DEBUG - find_failure_reason:94 Failed fetching reason\n2022-07-29 07:50:35,515:DEBUG - find_failure_reason:83 Fetch failure reason: https://logserver.rdoproject.org/openstack-component-common/opendev.org/openstack/tripleo-ci/master/periodic-tripleo-ci-centos-9-scenario004-standalone-common-master/d03f9f1/logs/failures_file\n2022-07-29 07:50:36,826:DEBUG - find_failure_reason:94 Failed fetching reason\n2022-07-29 07:50:36,827:DEBUG - find_failure_reason:83 Fetch failure reason: https://logserver.rdoproject.org/openstack-component-common/opendev.org/openstack/tripleo-ci/master/periodic-tripleo-ci-centos-9-standalone-common-master/a393b10/logs/failures_file\n2022-07-29 07:50:38,016:DEBUG - find_failure_reason:94 Failed fetching reason\n2022-07-29 07:50:38,018:DEBUG - find_failure_reason:83 Fetch failure reason: https://logserver.rdoproject.org/openstack-component-common/opendev.org/openstack/tripleo-ci/master/periodic-tripleo-ci-centos-9-undercloud-upgrade-common-master/627b998/logs/failures_file\n2022-07-29 07:50:39,408:DEBUG - find_failure_reason:94 Failed fetching reason\n2022-07-29 07:50:39,409:DEBUG - prepare_jobs:526 Prepared influxdb:\n~~~\n\nApart from that.. this step added ~29 s\n\n~~~\n2022-07-29 07:49:57,223:DEBUG - prepare_jobs:493 Fetch jobs details\n2022-07-29 07:50:28,948:DEBUG - prepare_jobs:496 Parsing jobs\n~~~\n\n\nLooks like adding below is adding these extra seconds.\n\n~~~\nzuul_jobs \u003d query_zuul_job_details(all_jobs)\n~~~",
      "parentUuid": "40adf103_1eea0098",
      "revId": "c9de5d85bc782e858a25d0eee29fab0e43f2e738",
      "serverId": "270e2033-b340-4cff-9539-693957ebf0e7"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c357b940_3da33b3e",
        "filename": "ci-scripts/infra-setup/roles/rrcockpit/files/telegraf_py3/ruck_rover.py",
        "patchSetId": 13
      },
      "lineNbr": 522,
      "author": {
        "id": 671
      },
      "writtenOn": "2022-07-28T09:13:31Z",
      "side": 1,
      "message": "Same comment as below for this.. We don\u0027t show duration on CLI(without --influx) - so we can skip adding this extra step.",
      "range": {
        "startLine": 522,
        "startChar": 0,
        "endLine": 522,
        "endChar": 33
      },
      "revId": "c9de5d85bc782e858a25d0eee29fab0e43f2e738",
      "serverId": "270e2033-b340-4cff-9539-693957ebf0e7"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a22359ed_bf47a6b4",
        "filename": "ci-scripts/infra-setup/roles/rrcockpit/files/telegraf_py3/ruck_rover.py",
        "patchSetId": 13
      },
      "lineNbr": 522,
      "author": {
        "id": 756
      },
      "writtenOn": "2022-08-10T01:55:37Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "c357b940_3da33b3e",
      "range": {
        "startLine": 522,
        "startChar": 0,
        "endLine": 522,
        "endChar": 33
      },
      "revId": "c9de5d85bc782e858a25d0eee29fab0e43f2e738",
      "serverId": "270e2033-b340-4cff-9539-693957ebf0e7"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6e0c0a57_e6be99ac",
        "filename": "ci-scripts/infra-setup/roles/rrcockpit/files/telegraf_py3/ruck_rover.py",
        "patchSetId": 13
      },
      "lineNbr": 525,
      "author": {
        "id": 671
      },
      "writtenOn": "2022-07-28T09:13:31Z",
      "side": 1,
      "message": "Maybe we can add a toggle here to not call find_failure_reason(log_url) (when we run via without --influx flag)",
      "range": {
        "startLine": 524,
        "startChar": 0,
        "endLine": 525,
        "endChar": 70
      },
      "revId": "c9de5d85bc782e858a25d0eee29fab0e43f2e738",
      "serverId": "270e2033-b340-4cff-9539-693957ebf0e7"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "017841be_83381192",
        "filename": "ci-scripts/infra-setup/roles/rrcockpit/files/telegraf_py3/ruck_rover.py",
        "patchSetId": 13
      },
      "lineNbr": 525,
      "author": {
        "id": 756
      },
      "writtenOn": "2022-07-28T21:24:56Z",
      "side": 1,
      "message": "The idea is to fetch all required data at once. If it\u0027s not being used by \"tables view\" it\u0027s just ignored. Similar for influx.",
      "parentUuid": "6e0c0a57_e6be99ac",
      "range": {
        "startLine": 524,
        "startChar": 0,
        "endLine": 525,
        "endChar": 70
      },
      "revId": "c9de5d85bc782e858a25d0eee29fab0e43f2e738",
      "serverId": "270e2033-b340-4cff-9539-693957ebf0e7"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "fab34974_b9807332",
        "filename": "ci-scripts/infra-setup/roles/rrcockpit/files/telegraf_py3/ruck_rover.py",
        "patchSetId": 13
      },
      "lineNbr": 525,
      "author": {
        "id": 756
      },
      "writtenOn": "2022-08-10T01:55:37Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "017841be_83381192",
      "range": {
        "startLine": 524,
        "startChar": 0,
        "endLine": 525,
        "endChar": 70
      },
      "revId": "c9de5d85bc782e858a25d0eee29fab0e43f2e738",
      "serverId": "270e2033-b340-4cff-9539-693957ebf0e7"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f920daee_afb9ee61",
        "filename": "ci-scripts/infra-setup/roles/rrcockpit/files/telegraf_py3/ruck_rover.py",
        "patchSetId": 13
      },
      "lineNbr": 563,
      "author": {
        "id": 192
      },
      "writtenOn": "2022-07-28T08:07:53Z",
      "side": 1,
      "message": "is the function rename really relevant to the change though?",
      "range": {
        "startLine": 563,
        "startChar": 4,
        "endLine": 563,
        "endChar": 17
      },
      "revId": "c9de5d85bc782e858a25d0eee29fab0e43f2e738",
      "serverId": "270e2033-b340-4cff-9539-693957ebf0e7"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "55a0dab7_673d3516",
        "filename": "ci-scripts/infra-setup/roles/rrcockpit/files/telegraf_py3/ruck_rover.py",
        "patchSetId": 13
      },
      "lineNbr": 563,
      "author": {
        "id": 756
      },
      "writtenOn": "2022-07-28T13:13:29Z",
      "side": 1,
      "message": "I went with aligning this function with other functions which start with `render_`",
      "parentUuid": "f920daee_afb9ee61",
      "range": {
        "startLine": 563,
        "startChar": 4,
        "endLine": 563,
        "endChar": 17
      },
      "revId": "c9de5d85bc782e858a25d0eee29fab0e43f2e738",
      "serverId": "270e2033-b340-4cff-9539-693957ebf0e7"
    }
  ]
}