---
# other than installing docker, need to install docker-python and ansible
# also need to start docker


# This playbook can be used to download the container images which
# passed CI and tag them back to rdoproject registry.
# It will also mirror the images to docker.io.
- name: Download and repush container images
  hosts: localhost
  become: yes
  become_user: root
  vars:
    target_registries:
      - host: docker.io
        namespace: "tripleo{{ lookup('env','RELEASE') }}"
        username: "{{ lookup('env','DOCKERHUB_USERNAME') }}"
        password: "{{ lookup('env','DOCKERHUB_PASSWORD') }}"
      - host: quay.io
        namespace: "tripleo{{ lookup('env','RELEASE') }}"
        username: "{{ lookup('env','QUAYDOTIO_USERNAME') }}"
        password: "{{ lookup('env','QUAYDOTIO_PASSWORD') }}"
        token: "{{ lookup('env','QUAYDOTIO_TOKEN') }}"
  tasks:
    - name: stat stage-info file
      stat:
        path: "/tmp/stage-info.yaml"
      register: stage_info_stat

    - name: Include info from staging environment
      include-vars: "/tmp/stage-info.yaml"
      when: stage_info_stat.stat.exists

    - name: override source registry if running under test
      set_fact:
        source_registry: "{{ registries.source_registry }}"
        target_registries: "{{ registries.target_registries }}"

    - include_role:
        name: containers-promote
