---
# other than installing docker, need to install docker-python and ansible
# also need to start docker


# This playbook can be used to download the container images which
# passed CI and tag them back to rdoproject registry.
# It will also mirror the images to docker.io.
- name: Download and repush container images
  hosts: localhost
  vars:
    target_registries:
      # There's no easy way to transparently override these hosts.
      # We would need to force their ip in /etc/hosts, but also reroute ports to
      # Their equivalent target registry
      - host: docker.io
        namespace: "{{ target_namespace }}"
        username: "{{ lookup('env','DOCKERHUB_USERNAME') }}"
        password: "{{ lookup('env','DOCKERHUB_PASSWORD') }}"
        auth_url: "https://index.docker.io/v1/"
        schema: "v2_s2"
#      - host: quay.io
#        namespace: "tripleo{{ lookup('env','RELEASE') }}"
#        username: "{{ lookup('env','QUAYDOTIO_USERNAME') }}"
#        password: "{{ lookup('env','QUAYDOTIO_PASSWORD') }}"
#        token: "{{ lookup('env','QUAYDOTIO_TOKEN') }}"
#        auth_url: "https://quay.io/api/v1/'"
#        schema: "v2_s1"
  tasks:
    # This same playbook will run in both production and testing.
    # If we are running in production we'll use the vars above.
    # If we are in testing we'll have to use the information provided by the staging setup
    # The most effective way for this playbook to understand that it's running in testing
    # is to check if a stage-info.yaml exists, then source and use its values.
    - name: stat stage-info file
      stat:
        path: "/tmp/stage-info.yaml"
      register: stage_info_stat

    - name: Override vars if running under tests
      when: stage_info_stat.stat.exists
      block:
        - name: Include info from staging environment
          # Setting no_log as this can potentially expose passwords
          no_log: true
          include_vars:
            file: "/tmp/stage-info.yaml"
            name: stage_info

        - name: override source registry if running under test
          # Setting no_log as this can potentially expose passwords
          no_log: true
          set_fact:
            source_registry: "{{ stage_info.registries.source }}"
            target_registries: "{{ stage_info.registries.targets }}"
            full_hash: "{{ stage_info.dlrn.promotions.promotion_candidate.full_hash }}"

    - name: "Check /tmp/zuul_vars.yaml file"
      stat:
        path: "/var/tmp/promoter_logs/zuul_vars.yaml"
      register: zuul_vars_file

    - name: "Include zuul vars if exists"
      when: zuul_vars_file.stat.exists
      block:
        - name: "Include zuul vars"
          no_log: true
          include_vars:
            file: "/var/tmp/promoter_logs/zuul_vars.yaml"

        - name: "Set facts"
          no_log: true
          set_fact:
            tmp_file_root: "{{ zuul.executor.log_root }}"
    # TODO(gcerami) assert that the hash associated to promote_name in dlrn is
    # different from full_hash. If that happens it means that promoted_name was
    # promoted before pushing the containers, and it's an error
    # Print out the two hashes anyway
    - include_role:
        name: containers-promote
