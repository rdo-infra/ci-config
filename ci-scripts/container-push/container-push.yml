---
# other than installing docker, need to install docker-python and ansible
# also need to start docker


# This playbook can be used to download the container images which
# passed CI and tag them back to rdoproject registry.
# It will also mirror the images to docker.io.
- name: Download and repush container images
  hosts: localhost
  become: yes
  become_user: root
  vars:
    target_registries:
      # There's no easy way to otransparently override these hosts.
      # We would need to force their ip in /etc/hosts, but also reroute ports to
      # Their equivalent target registry
      - host: docker.io
        namespace: "tripleo{{ lookup('env','RELEASE') }}"
        username: "{{ lookup('env','DOCKERHUB_USERNAME') }}"
        password: "{{ lookup('env','DOCKERHUB_PASSWORD') }}"
      - host: quay.io
        namespace: "tripleo{{ lookup('env','RELEASE') }}"
        username: "{{ lookup('env','QUAYDOTIO_USERNAME') }}"
        password: "{{ lookup('env','QUAYDOTIO_PASSWORD') }}"
        token: "{{ lookup('env','QUAYDOTIO_TOKEN') }}"
  tasks:
    # This is the most effective method to understand if we are running under test
    - name: stat stage-info file
      stat:
        path: "/tmp/stage-info.yaml"
      register: stage_info_stat

    - name: Override vars if running under tests
      when: stage_info_stat.stat.exists
      block:
        - name: Include info from staging environment
          include_vars: "/tmp/stage-info.yaml"

        - name: override source registry if running under test
          set_fact:
            source_registry: "{{ registries.source_registry }}"
            target_registries: "{{ registries.target_registries }}"

    - include_role:
        name: containers-promote
