---
- become: true
  block:
  - name: Create tripleo group
    group:
      name: tripleo
      state: present

  - name: Create users
    user:
      name: "{{ item.name }}"
      shell: /bin/bash
      groups: tripleo
      append: yes
    with_items: "{{ users }}"

  - name: Set authorized keys
    authorized_key:
      exclusive: yes
      user: "{{ item.name }}"
      state: present
      key: "{{ item.key }}"
    with_items: "{{ users }}"

  - name: Allow 'tripleo' group to have passwordless sudo
    lineinfile:
      dest: /etc/sudoers
      state: present
      line: '%tripleo ALL=(ALL) NOPASSWD: ALL'
      validate: 'visudo -cf %s'

  - name: Create persistent journal
    file:
      path: /var/log/journal/
      state: directory

  - name: Enable journald persistence
    ini_file:
      dest: "/etc/systemd/journald.conf"
      section: Journal
      option: Storage
      value: "Persistent"
      no_extra_spaces: yes
    register: journal_config

  - name: Restart journald
    systemd:
      name: systemd-journald
      state: restarted
    when: journal_config|changed

  - name: Install required packages
    yum:
      name: "{{ item }}"
      state: present
    with_items: "{{ packages }}"

  - name: Add cron job for ansible pull
    cron:
      name: "ansible-pull"
      minute: "*/5"
      job: ansible-pull -d /var/lib/ansible/local -U https://github.com/rdo-infra/ci-config.git --clean ci-scripts/infra-setup/servers_setup.yml 2>&1 >>/var/log/ansible-pull.log

  - name: Add configuration for the ansible-pull log rotation
    copy:
      content: |
          /var/log/ansible-pull.log {
              rotate 7
              daily
              compress
              missingok
              notifempty
          }
      dest: /etc/logrotate.d/ansible-pull
      owner: root
      group: root
      mode: 0644
