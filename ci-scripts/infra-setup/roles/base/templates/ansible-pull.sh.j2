#!/bin/bash

set -e

# Allow to skip running ansible-pull e.g. from cron
# which is useful during development and debugging.
# Use e.g. touch /tmp/skip-ansible-pull before running
# any ansible-playbook command from /var/lock/ansible-pull.
# Do NOT forget to remove /tmp/skip-ansible-pull once
# you are done!
if [ -e /tmp/skip-ansible-pull ]; then
    echo "Skipping ansible-pull" >&2
    exit 1
fi

(
    set -e
    flock -n 9 || exit 2

    cd /var/lib/ansible/local

{% if infra_setup_repo_refspec | default(None) != None %}
    git fetch --force '{{ infra_setup_repo }}' '{{ infra_setup_repo_refspec }}' &&
    git checkout --force FETCH_HEAD
{% else %}
    git fetch --force '{{ infra_setup_repo_default }}'
    git checkout --force master
{% endif %}

    ansible-playbook -c local -vvv \
        -l "localhost,$(hostname --short),$(hostname --fqdn),127.0.0.1" \
        -i '{{ infra_setup_inventory }}' \
        '{{ infra_setup_servers_playbook }}'
) 9>/var/lock/ansible-pull
