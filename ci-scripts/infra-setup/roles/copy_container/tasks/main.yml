---
- name: "Install centos-release-hyperscale for {{ ansible_distribution_major_version }}"
  become: true
  when: ansible_distribution_major_version is version('9', '>=')
  block:
    - name: "install epel-release"
      package:
        name: epel-release

    - name: "Install centos-release-hyperscale"
      package:
        name: centos-release-hyperscale

    - name: "Install centos-release-hyperscale-experimental"
      package:
        name: centos-release-hyperscale-experimental


- name: Install required packages
  package:
    name:
      - device-mapper-devel
      - gpgme-devel
      - btrfs-progs-devel
      - golang
  become: true

- name: Create temporary directory
  tempfile:
    state: directory
    suffix: copy-container
  register: temporary_copy_container_dir

- name: Copy go files to temporary directory
  copy:
    src: copy-quay/
    dest: "{{ temporary_copy_container_dir.path }}"

- name: Copy copy-quay config to home dir
  copy:
    src: copy-quay/config.yaml
    dest: "{{ ansible_user_dir }}/"

- name: Build the copy-container
  command:
    cmd: go build
    chdir: "{{ temporary_copy_container_dir.path }}"
  register: go_build
  changed_when: false

- name: Copy binary to /usr/local/bin
  copy:
    src: "{{ temporary_copy_container_dir.path }}/copy-quay"
    dest: /usr/local/bin
    mode: '0755'
    remote_src: true
  become: true
  when: go_build.rc == 0

- name: Delete temporary directory
  file:
    path: "{{ temporary_copy_container_dir.path }}"
    state: absent

- name: Install cron jobs
  include_tasks: cron.yml
  # become: true
  when: enable_cron|default(true)|bool
