---

- hosts: all
  vars:
    molecule_testing: true
    workspace: "/tmp"
    release: master
    promote_source: consistent
    zuul:
      molecule: true
  tasks:

    - name: Include required variables
      include_vars: ../../defaults/main.yml

    - block: &clean
      - name: check artifact file
        stat:
          path: "{{ artifact_path }}"
        register: artifact_file
        when:
          - artifact_path is defined
      - name: clean artifact path
        file:
          state: absent
          path: "{{ artifact_path }}"
        when:
          - artifact_path is defined
          - artifact_file is defined
          - artifact_file.stat.exists

    - block: *clean
      vars:
        artifact_path: "{{ workspace }}/commit.yaml"

    - name: get-hash for COMPONENT jobs (commit.yaml)
      block:
        - name: test get-hash.yaml for component job
          include_tasks: ../../tasks/get_hash.yaml
          vars:
            component: compute
        - name: validate hash_info for component job
          shell: |
            unset FULL_HASH
            unset COMPONENT_NAME
            source {{ workspace }}/hash_info.sh
            [[ -n ${FULL_HASH+x} ]] || exit 1
            [[ -n ${COMPONENT_NAME+x} ]] || exit 1

    - block: *clean
      vars:
        artifact_path: "{{ workspace }}/deorean.repo.md5"

    - name: get-hash for INTEGRATION jobs (.md5)
      block:
        - name: test get-hash.yaml for integration job
          include_tasks: ../../tasks/get_hash.yaml
          vars:
            component: !!null
        - name: validate hash_info for integration job
          shell: |
            unset FULL_HASH
            source {{ workspace }}/hash_info.sh
            [[ -n ${FULL_HASH+x} ]] || exit 1

    - block: *clean
      vars:
        artifact_path: "{{ workspace }}/commit.yaml"

    - name: get-hash for LEGACY jobs (commit.yaml)
      block:
        - name: test get-hash.yaml for legacy job
          include_tasks: ../../tasks/get_hash.yaml
          vars:
            ansible_distribution_major_version: 7
            component: !!null
        - name: validate hash_info for legacy job
          shell: |
            unset FULL_HASH
            source {{ workspace }}/hash_info.sh
            [[ -n ${FULL_HASH+x} ]] || exit 1
