- name: Create temporary key file
  tempfile:
    state: file
    prefix: infra-setup-
  register: keyfile

- name: generate file with public keys from users
  shell: |
    echo {{ item.1.key }} >> {{ keyfile.path }}
  when: item.1.state|default('present') == 'present'
  loop: "{{ users|subelements('keys') }}"
  changed_when: true

- name: Create Keypair from generated public key
  os_keypair:
    state: present
    name: "{{ default_keypair_name }}"
    public_key_file: "{{ keyfile.path }}"
