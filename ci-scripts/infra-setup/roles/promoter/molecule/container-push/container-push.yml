---
# other than installing docker, need to install docker-python and ansible
# also need to start docker


# This playbook can be used to download the container images which
# passed CI and tag them back to rdoproject registry.
# It will also mirror the images to docker.io.
- name: Download and repush container images
  hosts: localhost
  become: yes
  become_user: root
  vars:
    named_label: "{{ lookup('env', 'PROMOTE_NAME') }}"
    full_hash: "{{ lookup('env', 'FULL_HASH')}}"
    script_root: "{{ lookup('env', 'SCRIPT_ROOT') }}"
    distro_name: "{{ lookup('env', 'DISTRO_NAME') }}"
    distro_version: "{{ lookup('env', 'DISTRO_VERSION') }}"
    release: "{{ lookup('env','RELEASE') }}"
    dockerhub_namespace: "tripleo{{ lookup('env','RELEASE') }}"
    dockerhub_username: "{{ lookup('env','DOCKERHUB_USERNAME') }}"
    dockerhub_password: "{{ lookup('env','DOCKERHUB_PASSWORD') }}"
    rdoproject_namespace: "tripleo{{ lookup('env','RELEASE') }}"
    rdoproject_username: "{{ lookup('env','RDOPROJECT_USERNAME') }}"
    rdoproject_password: "{{ lookup('env','RDOPROJECT_PASSWORD') }}"
    quaydotio_namespace: "tripleo{{ lookup('env','RELEASE') }}"
    quaydotio_username: "{{ lookup('env','QUAYDOTIO_USERNAME') }}"
    quaydotio_password: "{{ lookup('env','QUAYDOTIO_PASSWORD') }}"
    quaydotio_token: "{{ lookup('env','QUAYDOTIO_TOKEN') }}"
    containers_file: "parsed_containers-{{ distro_name }}-{{ distro_version }}-{{ lookup('env','RELEASE') }}.txt"
    registry_api: "https://trunk.registry.rdoproject.org:8443/oapi/v1/namespaces/tripleo{{ lookup('env', 'RELEASE') }}/imagestreamtags"
  tasks:
    - include_tasks: containers-promote.yml
