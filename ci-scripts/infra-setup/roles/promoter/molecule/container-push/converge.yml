---
- name: Disable target push, only promote containers in source registry
  hosts: all
  vars:
    # The way the container-push works, there's currently no way to test the vars lookup directly
    # so we are passing the vars directly here, but this reduces coverage: if we
    # change the lookup, they don't get any test
    # Unfortunately adding coverage for those requires a refactoring of the way vars are passed
    # to the container-push in general, which is way too difficult to do right now.
    release: master
    named_label: triple-ci-staging-promoted
    # full_hash is provided by the staging environment
    script_root: UNUSED
    distro_name: centos
    distro_version: 8
    containers_file: "parsed_containers-{{ distro_name }}-{{ distro_version }}-{{ release }}.txt"
    target_registries_push: false
    containers_list:
      - nova-compute
      - neutron-server

  tasks:
    - name: call tasks to manage variables
      include_tasks: ../provision/manage_variables.yml

    - name: include stage setup variables
      include_vars:
        file: "/tmp/stage-info.yaml"
        name: stage_info

    - name: sets critical variables
      set_fact:
        full_hash: "{{ stage_info.dlrn.promotions.promotion_candidate.full_hash }}"
        source_registry: "{{ stage_info.registries.source }}"
        target_registries: "{{ stage_info.registries.targets }}"

    - name: Include containers-promote role to test
      include_role:
        name: ../../../../../container-push/roles/containers-promote
      vars:
        ansible_python_interpreter: "/home/{{ promoter_user }}/promoter_venv/bin/python3"
