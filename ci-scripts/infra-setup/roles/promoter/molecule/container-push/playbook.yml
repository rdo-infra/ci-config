---
# other than installing docker, need to install docker-python and ansible
# also need to start docker


# This playbook can be used to download the container images which
# passed CI and tag them back to rdoproject registry.
# It will also mirror the images to docker.io.
- name: Download and repush container images
  hosts: all
  vars:
    localhost_registry_container: manifest-local-registry
    release: master
    named_label: triple-ci-staging-promoted
    full_hash: 82a1e08b25e42f1e8ea99d7c9b6957bb06423a34_dae2ef8
    script_root: UNUSED
    distro_name: centos
    distro_version: 7
    dockerhub_namespace: "tripleo{{ release }}"
    dockerhub_username: unused
    dockerhub_password: unused
    rdoproject_namespace: "tripleo{{ release }}"
    rdoproject_username: unused
    rdoproject_password: unused
    quaydotio_namespace: "tripleo{{ release }}"
    quaydotio_username: unused
    quaydotio_password: unused
    quaydotio_token: unused
    containers_file: "parsed_containers-{{ distro_name }}-{{ distro_version }}-{{ release }}.txt"
    source_registry: localhost:5000
    registry_api: "https://trunk.registry.rdoproject.org:8443/oapi/v1/namespaces/tripleo{{ lookup('env', 'RELEASE')  }}/imagestreamtags"
  tasks:
    - name: Test promoter container manifest-push.yml
      block:
        - name: Run docker registry for {{ manifest_registry }}
          shell: |
            docker pull registry
            docker run -d -p 5000:5000 --restart=always --name manifest-local-registry registry
            docker tag registry:2 {{ source_registry }}/tripleomaster/centos-binary-base:{{ full_hash }}
            docker tag registry:2 {{ source_registry }}/tripleomaster/centos-binary-openstack-base:{{ full_hash }}
            docker push {{ source_registry }}/tripleomaster/centos-binary-base:{{ full_hash }}
            docker push {{ source_registry }}/tripleomaster/centos-binary-openstack-base:{{ full_hash }}
            docker rmi {{ source_registry }}/tripleomaster/centos-binary-base:{{ full_hash }}
            docker rmi {{ source_registry }}/tripleomaster/centos-binary-openstack-base:{{ full_hash }}

        - copy:
            content: |
                {% raw -%}
                {{name_prefix}}base{{name_suffix}}
                {{name_prefix}}openstack-base{{name_suffix}}
                {%- endraw %}
            dest: /tmp/release_url


        - include_role:
            name: ../../../../../container-push/roles/containers-promote
          # The way the container-push works, there's currently no way to test the vars lookup directly
          # so we are passing the vars directly here, but this reduces coverage: if we
          # change the lookup, they don't get any test
          # Unfortunately ading coverage for those requires a refactoring of the way vars are passed
          # to the container-push in general, which is way too difficult to do right now.
          vars:
            release_url: file:///tmp/release_url

      always:

        - name: 'Stop and remove {{ localhost_registry_container }}'
          shell: |
            docker container stop {{ localhost_registry_container }}
            docker container rm {{ localhost_registry_container }}

