- name: tripleo-common integration scenario
  vars:
    release: master
    # full_hash is provided by the staging environment
    script_root: UNUSED
    distro_name: centos
    distro_version: 8
    containers_file: "../container-push/parsed_containers-{{ distro_name }}-{{ distro_version }}-{{ release }}.txt"
    undercloud_registry:
      name: local-undercloud-registry
      host: 127.0.0.1:8787
      username: unused
      password: unused
      namespace: "tripleo{{ release }}"

  tasks:
    - name: remove staging files
      file:
        path: "{{ item }}"
        state: absent
      with_items:
        - /tmp/staging_overcloud_containers.yaml.j2
        - /tmp/staging-containers-prepare-parameter.yaml
      tags:
        - registry_cleanup

    - name: remove local containers
      docker_image:
        name: "{{ undercloud_registry['host'] }}/{{ undercloud_registry['namespace'] }}/{{ distro_name }}-binary-{{ item }}:{{ full_hash }}"
        state: absent
      with_items: "{{ lookup('file', containers_file ).splitlines() }}"
      tags:
        - registry_cleanup

    - name: Stop and remove registries
      docker_container:
        name: "{{ undercloud_registry['name'] }}"
        state: absent
      tags:
        - registry_cleanup
