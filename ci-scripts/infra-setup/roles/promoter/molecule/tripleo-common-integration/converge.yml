---
- name: tripleo-common integration scenario
  vars:
    # vars from container-push-multiarch are copied here
    # since container-push prepare/converge are pre-reqs for
    # tripleo-common-integration scenario
    release: master
    named_label: triple-ci-staging-promoted
    # full_hash is provided by the staging environment
    script_root: UNUSED
    distro_name: centos
    distro_version: 8
    containers_file: "/tmp/parsed_containers-{{ distro_name }}-{{ distro_version }}-{{ release }}.txt"
    # Source and target registries are provided by staging environment
    manifest_push: true
    ppc_manifests: true
    # Decrease the chance the ppc_manifests is disabled by our check
    ppc_pull_attempts: 3
    containers_list:
      - nova-compute
      - neutron-server
  hosts: all
  tasks:

    - name: call tasks to manage variables
      include_tasks: ../provision/manage_variables.yml


    # image prepare pulls from promote_registry and pushes to undercloud_registry
    - name: run container image prepare # noqa 301
      shell: |
        source /home/{{ promoter_user }}/promoter_venv/bin/activate
        openstack tripleo container image prepare --verbose \
            -e /tmp/staging-containers-prepare-parameter.yaml \
            --output-env-file /tmp/containers-default-parameters.yaml \
            2>&1 > /tmp/tripleo-container-image.prepare.log
