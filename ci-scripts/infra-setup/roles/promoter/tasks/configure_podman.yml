---
#
# Start podman service
#

- name: Make sure /etc/docker present
  become: true
  block:
    - name: Create /etc/docker dir
      file:
        path: '/etc/containers/registries.conf.d'
        state: directory
        owner: root
        group: root


    - name: Configure insecure registries
      become: true
      copy:
        dest: "/etc/containers/registries.conf.d/{{ item.port }}_registry.conf"
        content: |
          [[registry]]
          location = "{{ item.host }}:{{ item.port }}"
          insecure = true
      with_items:
        - { host: "localhost", port: 3000 }
        - { host: "localhost", port: 5000 }

- name: Reload, enable and start podman
  become: true
  block:
    - name: Reload podman if config was changed
      service:
        name: podman
        state: reloaded

    - name: Start and enable Podman
      service:
        name: podman
        state: started
        enabled: yes

    - name: Configure podman socket
      file:
        path: "/run/podman/podman.sock"
        owner: "{{ promoter_user }}"
        mode: "0755"
