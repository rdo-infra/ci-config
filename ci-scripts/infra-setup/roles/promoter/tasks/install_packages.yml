- name: Configure repositories
  become: true
  block:
    - name: Set proper release for the OS
      set_fact:
        distro: "{{ (ansible_distribution == 'CentOS') | ternary('centos', 'rhel') }}"

    - name:  Install epel
      package:
        name: epel-release
        state: present

    - name: Enable epel
      command: yum-config-manager --enable epel
      args:
        warn: false

    - name: Install influxdb repo to get telegraf
      yum_repository:
        name: influxdb
        description: "InfluxDB Repository - {{ distro }}"
        baseurl: "https://repos.influxdata.com/{{ distro }}/$releasever/$basearch/stable"
        enabled: yes
        gpgcheck: yes
        gpgkey: https://repos.influxdata.com/influxdb.key

- name: Install required packages
  become: true
  yum:
    name:
      - ansible
      - device-mapper-persistent-data
      - git
      - httpd
      - libselinux-python3
      - logrotate
      - lvm2
      - openssh
      - parted
      - policycoreutils
      - "{{ (ansible_distribution_major_version|int >= 8) | ternary('python3-virtualenv', 'python36-virtualenv') }}"
      - setools-console
      - telegraf
      - xfsprogs
      - yum-utils
    state: present
