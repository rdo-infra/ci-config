# This role is meant to run in 3 different environments:
#  STANDALONE, ZUUL, and MOLECULE
#
# - STANDALONE (production promoter server in real host or vm)
#   should be run only after merging tested code, to actually provision the real server
#   with continuous deployment afterwards. RUNS THE ROLE AS ROOT
# - ZUUL ci job in staging promoter (nodepool node)
#   watch the test in your ci job
# - MOLECULE testing (local docker driver)
#   test and iterate over it before submitting changes
#   This environment should be taken into consideration, but major
#   task for it should be added in the molecule playbooks directly
#   and not here
#
#   ALL refers to all environments above


# This part of the role is continuously called by the production server
# as a mean for continuous delivery and code update in the server.
# The call in production is currently done by a root crontab installed a
# intance creation time by cloud-init.
# This can be changed in the future, but currently this role *MUST* be run
# as root especially in the tests, to mimic what's happening in production

- name: Check user id
  command: id -u
  register: user_id
  changed_when: false

- name: fail if this role is not run as root
  fail:
    msg: This role must be run as root.
  when: user_id.stdout != '0'

- include_tasks: repos-packages.yml

- include_tasks: containers-partition.yml

- include_tasks: docker.yml

- include_tasks: logs.yml

- include_tasks: apache-logs.yml

- include_tasks: credentials.yml

- include_tasks: promoter-code-repo.yml

- include_tasks: promoter.yml

- include_tasks: monitoring.yml
