- become: true
  block:
    - name: Mount external volume - create a partition
      parted:
        device: /dev/vdb
        number: 1
        state: present

    - name: Mount external volume - create a filesystem
      filesystem:
        fstype: xfs
        dev: /dev/vdb1

    - name: create a mount folder
      file:
        path: /var/lib/docker
        state: directory

    - name: Mount external volume - mount the partition
      mount:
        path: /var/lib/docker
        src: /dev/vdb1
        fstype: xfs
        state: mounted

- name: Create a directory for the promoter logs
  file:
    path: '~/promoter_logs'
    state: directory
    setype: httpd_sys_content_t

- name: copy logrotate selinux policy
  copy:
    src: logrotate-promoter.te
    dest: /tmp/logrotate-promoter.te
  register: policy

- name: compile and permanently install policy
  shell: |
      checkmodule -M -m -o /tmp/logrotate-promoter.mod /tmp/logrotate-promoter.te
      semodule_package -m /tmp/logrotate-promoter.mod -o /tmp/logrotate-promoter.pp
      semodule -i /tmp/logrotate-promoter.pp
      rm -f /tmp/logrotate-promoter.pp /tmp/logrotate-promoter.mod
  become: true
  when: policy|changed

- name: Fix home directory permissions
  file:
    path: '~'
    mode: 0755

- become: true
  block:
    - name: Disable the default welcome page
      copy:
        content: ''
        dest: '/etc/httpd/conf.d/welcome.conf'
        backup: yes

    - name: Add config file for Apache to expose the logs
      blockinfile:
        path: '/etc/httpd/conf.d/promoter_logs.conf'
        create: yes
        block: |
          <VirtualHost *:80>
              ServerAdmin rdo-ci-admins@redhat.com
              DocumentRoot "{{ ansible_env.HOME }}/promoter_logs"

              <Directory {{ ansible_env.HOME }}/promoter_logs>
                  Options Indexes MultiViews
                  AllowOverride None
                  Require all granted
              </Directory>
          </VirtualHost>
      register: apache_config

    - name: Start and enable Apache
      service:
        name: httpd
        state: restarted
        enabled: yes
      when: apache_config|changed

    - name: Start and enable Docker
      service:
        name: docker
        state: started
        enabled: yes

- name: Clone to the ci-config repo
  git:
    repo: 'https://review.rdoproject.org/r/p/rdo-infra/ci-config.git'
    dest: '~/ci-config'

- name: Add keypair for the images server
  copy:
    content: '{{ uploader_ssh_priv_key }}'
    dest: '{{ ansible_env.HOME }}/.ssh/id_rsa'
    mode: 0600
  register: priv_key

- name: Generate public key from private key for uploader user
  shell: >
    ssh-keygen -y -t rsa -N '' -f ~/.ssh/id_rsa > ~/.ssh/id_rsa.pub
  args:
    creates: /home/centos/.ssh/id_rsa.pub
  when: priv_key|changed

- name: Create a virtualenv for the promoter script
  pip:
    requirements: ~/ci-config/ci-scripts/dlrnapi_promoter/requirements.txt
    virtualenv: ~/promoter_venv

- name: Add a cron jobs to run the promotion script
  cron:
    name: 'promoter script for the {{ item.release }} branch'
    minute: '{{ item.minute }}'
    # TODO(gcerami) I think the job command deserves a script on its own
    job: 'source ~/registry_secret; source ~/dlrnapi_secret; source ~/promoter_venv/bin/activate; /usr/bin/timeout --preserve-status -k 120m 115m python ~/ci-config/ci-scripts/dlrnapi_promoter/dlrnapi_promoter.py ~/ci-config/ci-scripts/dlrnapi_promoter/config/{{ item.release }}.ini'
  with_items:
    - { release: 'master', minute: '1,11,21,31,41,51' }
    - { release: 'queens', minute: '4,14,24,34,44,54' }
    - { release: 'pike', minute: '2,12,22,32,42,52' }
    - { release: 'ocata', minute: '3,13,23,33,43,53' }

- name: add configuration for the log rotation
  copy:
    content: |
        /home/centos/promoter_logs/*.log {
            daily
            missingok
            su centos centos
            dateext
            dateyesterday
            notifempty
            delaycompress
            rotate 60
        }
    dest: /etc/logrotate.d/promoter
    owner: root
    group: root
    mode: 0644
  become: true
