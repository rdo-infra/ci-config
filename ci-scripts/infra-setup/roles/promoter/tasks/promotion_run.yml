---
- name: run promoter script on the staging environment
  become: true
  become_user: "{{ promoter_user }}"
  shell:
    cmd: |
      source /home/{{ promoter_user }}/promoter_venv/bin/activate
      {{ ci_config_remote_src_dir }}/ci-scripts/dlrnapi_promoter/dlrn-promoter.sh -s

- name: extract log_file from staging.ini
  shell:
    cmd: |
       grep log_file config/CentOS-7/staging.ini | awk '{ print $2 }'
  register: log_file_grep
  args:
    chdir: "{{ ci_config_remote_src_dir }}/ci-scripts/dlrnapi_promoter"

- name: check if dlrn api actually finished a promotion process
  become: true
  become_user: "{{ promoter_user }}"
  command: "grep 'FINISHED promotion process' {{ log_file_grep.stdout }}"

- name: run the promoter workflow tests
  become: true
  become_user: "{{ promoter_user }}"
  shell:
    cmd: |
      source /home/{{ promoter_user }}/promoter_venv/bin/activate
        # Export the path to the mounted docker socket so all docker client commands will use it
        if [ -S /tmp/docker.sock ]; then
            export DOCKER_HOST=unix:///tmp/docker.sock
            export DOCKER_OPTS="--insecure-registry localhost:{{ initial_registry['port'] }}"
        fi
        # python {{ ci_config_remote_src_dir }}/ci-scripts/dlrnapi_promoter/tests/staging-setup/test_promoter.py
