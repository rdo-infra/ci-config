---
- name: Pull images
  environment:
    GRAFANA_ADMIN_PASSWORD: "{{ grafana_admin_password }}"
    GRAFANA_SMTP_PASSWORD: "{{ grafana_smtp_password }}"
  shell:
    cmd: podman-compose --file /tmp/infra-setup/roles/rrcockpit/files/docker-compose.yml pull
  register: pull_cmd
  failed_when: pull_cmd.rc != 0

- name: Build containers
  environment:
    GRAFANA_ADMIN_PASSWORD: "{{ grafana_admin_password }}"
    GRAFANA_SMTP_PASSWORD: "{{ grafana_smtp_password }}"
  shell:
    cmd: podman-compose --file /tmp/infra-setup/roles/rrcockpit/files/docker-compose.yml build
  register: build_cmd
  failed_when: build_cmd.rc != 0

# NOTE(dasm): During startup, Grafana has problems when pulling plugins, hence ensure DNS
- name: Add Google DNS if not present
  become: true
  lineinfile:
    dest: /etc/resolv.conf
    insertbefore: BOF
    line: "nameserver 8.8.8.8"
    state: present

- name: Start services
  environment:
    GRAFANA_ADMIN_PASSWORD: "{{ grafana_admin_password }}"
    GRAFANA_SMTP_PASSWORD: "{{ grafana_smtp_password }}"
  shell:
    cmd: podman-compose --file /tmp/infra-setup/roles/rrcockpit/files/docker-compose.yml up --detach
  register: up_cmd
  failed_when: up_cmd.rc != 0
