- name: Set up the te-broker server on rdocloud
  hosts: localhost
  tasks:

    - name: Fail if no auth is provided
      fail:
        msg: 'Please source credential rc file from the tenant on cloud'
      when: "lookup('env', 'OS_USERNAME') == ''"

    - name: Create tripleo-cd-admins keypair for bmc nodes
      os_keypair:
        state: present
        name: tripleo-cd-admins
        public_key: |
          ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDfZ1CezNQCbPJsShmpF3F2VnhofEwoertmObne8U8tJ4Zi6kiV7wErIqPAXBGNthzJs8V3pgfiXP2yexgQz4eqd7BsdGovmBXV+bbHMrC6IG2E337pIGJ+W9Mb5nvWFjxmWEr+G/dG3AWZor1lak21ZSJkbioF0EA7r6y8nY1N75nIAuZEqFhciDAP8uenSYTb3EDC1vsrigkHiZeC4B0atj0NpqbaQWRx0D0Y7MSt5wgwm0DNk5C3u6zEKJz60JYRBIhYCtoK5BUMkssD9/ysc3JR0ctw0jkfCv1zsbp5ah6IZ15aYo2Ze3OYZCfbnqoH+zOppH5YvOisUMoHy24n derekh@laptop
          ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA+yNMzUrQXa0EOfv+WJtfmLO1WdoOaD47G9qwllSUc4GPRkYzkTNdxcEPrR3XBR94ctOeWOHZ/w7ymhvwK5LLsoNBK+WgRz/mg8oHcii2GoL0fNojdwUMyFMIJxJT+iwjF/omyhyrW/aLAztAKRO7BdOkNlXMAAcMxKzQtFqdZm09ghoImu3BPYUTyDKHMp+t0P1d7mkHdd719oDfMf+5miHxQeJZJCWAsGwroN7k8a46rvezDHEygBsDAF2ZpS2iGMABos/vTp1oyHkCgCqc3rM0OoKqcKB5iQ9Qaqi5ung08BXP/PHfVynXzdGMjTh4w+6jiMw7Dx2GrQIJsDolKQ== dan.prince@dovetail
          ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDSP0DZRAwaTAvHk7mHlLfSwVq6QCRqKn8mE6nwW1UzBmTzKdq9pK5XPqEAQgUKoarl+M+QhCNrBaNKpUqPF1dH76S0+2k2HARrxubTlXsQ9UDQQHQZxGjsrYW9sZ/F7yh4Yac7HW4pZANumyAxt0yKE0BLTZX9JojaiBn7bMzw1i5BS6qXIyH7oohd3YThxkpMCqP4O6W6wX90FSDYPtbSaZ1Q+9hzNkS29bXcsoy6uwTixkfedsCgkLb2wa9jcDHCely94Tn/oR+JjT9OQ19Tq8p/rjL8lullIrkHsEEsQ/4sIlB6441DgbeLtQAPPA7pyw50KfBCyTfHQZWPsacN jslagle@redhat.com
          ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDv9l/F0vq7nzAT5hdrBfqDv0rD76nHNn+siS6s5gaFyAuvXJG808pqFk5bJLbRdRIA1/cLxIQeB+bB7IjeTS7Afbz/baAOPTtoumwEU8wLPzR7IyTg60R4o7pKOJG2cP45s3TGODsYt5eEAr96EGp9ayyanfuJZZf2wQWdNp1+vQXain8WHv9KIKI5XmcKI80x8RBWV86OKKsmbqV4yYxAkuLitq4h3Bhw3LP+VOxaqApevnpt7fcrvn8QR3XMsLKNZsJhT9r1qeLEZisundZPN+0EuiC7seu5zAuCBcKjRrBo7Ime8TYn5sjz9DTMcWvY3xHF2DZN2YdVxp4O8/iD bnemec@localhost.localdomain
          ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDDhi/BqsZibuAPiUjJe7b3Dqe5nyI7BckOwfGwJYg436+bFQMoR/7RKmtPe+ISVQ04lwIriIPwKGaSHj5mbEe4LsCLZ5jAUHxvWfgHitqS5ln295zU7vp1z28o7e6LQNplgExyqQlxUPdOU48tmlz93F6szSYkNYvZnhzMn9syrajC74qPuKsmHTeYFLEcxesb7/u+BtxCk8WdjYTb//sk038NEtIsNhrGtAOV3WcDpXnA5mNMpUfeoQ4yiN9LqtreXr7Zeo587LV3T2QL+huAE0J7EuCzHAKk6TIzJqjLidg0SYwZZwfbxgviU66QLkeyzh9oiovwskelvOQCBFq3 sshnaidm@redhat.com
          ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDYt5FqMTz91Mbctj7wWg2tAkzwMDwDFtvw0l/6SGPqV+w84SxM1sRmCm1iGdjCk7Rhy3493yRMrA6RT02yTQnXyXG5xC9stspWku9GPNNXyg83SvC/iz53E5SWwYQISmgBK+dYNwzjiN8C8ohxmT8elV1ElckgGvzTOk80KygUzpf+KOfezQcSXZWxBbYsK/8FamPBoWGLCByv+zVX+dSjNgraqdGZDlXns+NiZAeEHeBwKTufFpN//1xm4lG+ah4g5oqaXNf1M7LApPSSm4r5VdFp0+S5SbcPocu+ztwttstnLI0fgJ5XUyqUJM0fZbaj1qkhFeG7bCi/75XIjnkp emilien@redhat.com
          ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDMZI3iVVe8UO6NdHJrGUwglumu4Tgz0yBzQky5aJtuFBfPLAd0LKz2dCq91oXUZ1EprKJgxU9cB2ydFcd2baHDstsJDf0Rg3wvZdwtM8g7q6xsOE/uhwn192ZQR2EK6HlfjUoNTYJvRsuTHJ9u+xpAsLjau6I/A7aE9U7yNhJNfiGBagEdelvKujSyxdWq9ZBMFb5HKLg346OaD0xHJFS/574mKlCZkq991i8pf8nGheIkJ1XtRWCtbc8v0vKccgxVlHUxFegRTsrKIHnQfm0JHnpLaf24yrXEJhnwYHqKH5fYN6IeReV3bq0A08vH4O/O5+BJRM0J/WXhXOTvjy6pZlLyjF7KOTpESz0EZYuWgvRC2+QHTwXlAtlILnjx8N8Al0pVwz/IJ0bdZzS7+usaZvka350aCaHyRXtuwtydd1lOkz34nbJAEzsCmeaS8JH/EWfD5BuaqaZRMs2GkMEK3Ey9JVOGGb4wiHDOk3f+IQHMMz9y7Cv17jeQ+CBgFUqb1mACjg2fXnyDJCcA7EXFB+ksI4slg0rei37DOXSDe8lFhwtMum9UQf8HpYJkepbMRa3OvdibrXeGCb3+SoAE0EKLkzqKSK+UfNA2hX8a1IKsTDGLF8b91AS2NaYUISHCRCLNhwEGeDAjjkIhxy3K94nTTHbHRrRhnVvZeDDC4Q== josorior@redhat.com
          ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDiJ2p/mxivnTas4Dw5d8mBs+KJMP/qk3HAQ7DPx0kcVUXPL1lgD7TowtdpOn5tyjsGg73/b+SzmrUyRdwsUHmTXL7H8pgdar+fYwCbNmmzhToCnB2GpMqQ1W1F6icJt1d0QXeUvJMGQz/X9p9X9I5LciFEzfA04sFTn+nUXyhdB3Tt/wHFEI4xXjIvbK7wx4QMGRDDJJGT3KbmhKOSWljILgPB54i10wg3xJLfW8fwiF2J160j6wsHztuJLT/v8ZhanEq/euNQ6vEApAvbVHpEg5aPO3x9/7ZFZ5K4TN0YGJ22ffkYvaaauNc5sdvTyV5j9jg5xJtdyVcxyBxc66Of gcerami@redpanda

    - name: Create a port with fixed IP
      os_port:
        name: te-broker-port
        network: private
        state: present
        fixed_ips:
          - ip_address: 192.168.103.254
        security_groups:
          - default

    - name: Create the te-broker server instance
      os_server:
        state: present
        name: te-broker
        auto_floating_ip: yes
        flavor: ci.m1.medium
        image: CentOS-7-x86_64-GenericCloud-1801-01
        key_name: tripleo-ci-team
        nics:
          - port-name: te-broker-port
        timeout: 300
      register: 'os_host'
    - name: add hosts to inventory
      add_host:
        name: '{{ os_host.openstack.name }}'
        ansible_user: centos
        ansible_host: '{{ os_host.openstack.accessIPv4 }}'
        ansible_ssh_extra_args: '-o StrictHostKeyChecking=no'

    - name: Let it be up
      pause: seconds=60
