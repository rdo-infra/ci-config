- builder:
    name: phase-test-import-train-centos7-current-tripleo
    builders:
        - multijob:
            name: "INSTALL / TEST (IMPORT IMAGES)"
            condition: UNSTABLE
            projects:
                - name: weirdo-train-promote-packstack-scenario001
                  kill-phase-on: NEVER
                - name: weirdo-train-promote-packstack-scenario002
                  kill-phase-on: NEVER
                - name: weirdo-train-promote-packstack-scenario003
                  kill-phase-on: NEVER
                - name: weirdo-train-promote-puppet-openstack-scenario001
                  kill-phase-on: NEVER
                - name: weirdo-train-promote-puppet-openstack-scenario002
                  kill-phase-on: NEVER
                - name: weirdo-train-promote-puppet-openstack-scenario003
                  kill-phase-on: NEVER
                - name: weirdo-train-promote-puppet-openstack-scenario004
                  kill-phase-on: NEVER

- job-template:
    name: rdo_trunk-promote-train-centos7-current-tripleo
    project-type: multijob
    triggers:
        - pollurl:
            cron: "H * * * *"
            urls:
                - url: https://trunk.rdoproject.org/centos7-train/current-tripleo/delorean.repo
                  check-content:
                    - simple: true
    defaults: parent-promote-defaults
    builders:
        - phase-get-hash-train-centos7-current-tripleo
        - phase-test-import-train-centos7-current-tripleo
    properties:
        - ownership:
            owner: whayutin@redhat.com

- builder:
    name: phase-get-hash-train-centos7-current-tripleo
    builders:
        - multijob:
            name: "GET THE LATEST DELOREAN YUM REPOSITORY HASH"
            condition: SUCCESSFUL
            projects:
              - name: rdo-promote-get-hash-train-centos7-current-tripleo

- publisher:
    name: 'tripleo-quickstart-archive-hash-train-centos7-current-tripleo'
    publishers:
        - archive:
            artifacts: 'delorean_train_centos7_current_tripleo_hash'

- job-template:
    name: 'rdo-promote-get-hash-train-centos7-current-tripleo'
    defaults: script-defaults
    builders:
        - shell:
            !include-raw-escape:
                - scripts/centos-train-centos7-current-tripleo.sh
                - scripts/promote-get-hash.sh
    publishers:
        - tripleo-quickstart-archive-hash-train-centos7-current-tripleo
    properties:
        - ownership:
            owner: whayutin@redhat.com

- project:
    name: rdo_trunk-promote-jobs-train-centos7-current-tripleo
    jobs:
        - 'rdo_trunk-promote-train-centos7-current-tripleo'

- project:
    name: rdo-promote-get-hash-train-centos7-current-tripleo
    jobs:
        - 'rdo-promote-get-hash-train-centos7-current-tripleo'

- project:
    name: 'weirdo-promote-jobs-centos7'
    openstack_release:
        - 'train':
            tempest_from_source: 'false'
    playbook:
        - 'puppet-openstack-scenario001'
        - 'packstack-scenario001'
    jobs:
        - weirdo-{openstack_release}-centos7-promote-{playbook}

- job-template:
    name: 'weirdo-{openstack_release}-centos7-promote-{playbook}'
    defaults: 'weirdo-promote-defaults'
    description: |
        <p>Managed by Jenkins Job Builder. Do not edit via web.</p>
        <br>
        <p>This job runs <a href="https://github.com/redhat-openstack/weirdo" target="_blank">WeIRDO</a>.</p>
        <p>It runs the playbook <a href="https://github.com/redhat-openstack/weirdo/blob/master/playbooks/{playbook}.yml" target="_blank">{playbook}.yml</a></p>
        <br>
        This is what this job runs:
        <pre>
        if [[ "{openstack_release}" != "master" ]]; then
            version="stable/{openstack_release}"
        else
            version="{openstack_release}"
        fi

        # Use variables provided by a job earlier in the pipeline, if available
        delorean_hash=${{delorean_current_hash:-current}}
        delorean_url="http://trunk.rdoproject.org/centos8-{openstack_release}/${{delorean_hash}}/delorean.repo"
        delorean_deps_url="http://trunk.rdoproject.org/centos8-{openstack_release}/delorean-deps.repo"

        # Use WeIRDO provided by jenkins scm
        cd weirdo
        git log -n 5 --oneline
        tox -e ansible-playbook -- -i ${{WORKSPACE}}/hosts playbooks/{playbook}.yml \
          -e ci_environment=ci-centos \
          -e delorean_url=$delorean_url \
          -e delorean_deps_url=$delorean_deps_url \
          -e openstack_release={openstack_release} \
          -e version=$version
        </pre>

    scm:
        - weirdo-core-master-repository
    builders:
        - copyartifact:
            project: rdo-promote-get-hash-{openstack_release}-centos7-current-tripleo
            filter: "delorean_{openstack_release}_centos7_current_tripleo_hash"
            target: /tmp
            which-build: multijob-build
            optional: false
        - inject:
            properties-file: "/tmp/delorean_{openstack_release}_centos7_current_tripleo_hash"
        - rdo-generate-log-rdoproject-org-redirection
        - weirdo-get-node
        - weirdo-promote-ansible-playbook-builder:
            openstack_release: '{openstack_release}'
            playbook: '{playbook}'
    publishers:
        - weirdo-archive-logs
        - weirdo-release-node
        - weirdo-report-dlrn-api
