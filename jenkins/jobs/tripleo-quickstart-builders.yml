- builder:
    name: 'tripleo-quickstart-builder'
    builders:
        - shell: |
              echo "git+https://review.rdoproject.org/r/rdo-infra/ci-config/#egg=ci-conf" >> $WORKSPACE/quickstart-extras-requirements.txt

              bash $WORKSPACE/tripleo-quickstart/ci-scripts/get-node.sh
              export VIRTHOST=$(head -n1 $WORKSPACE/virthost)
              echo $VIRTHOST

              pushd $WORKSPACE/tripleo-quickstart

              bash $WORKSPACE/tripleo-quickstart/ci-scripts/{test}.sh \
                {release} \
                {build_system} \
                {topology} \
                {job_type} \
                {environment}

              popd

- builder:
    name: 'tripleo-quickstart-rdo-infra-builder'
    builders:
        - shell: |
              echo "git+https://review.rdoproject.org/r/rdo-infra/ci-config/#egg=ci-conf" >> $WORKSPACE/quickstart-extras-requirements.txt

              bash $WORKSPACE/ci-config/ci-scripts/checkout-patches.sh

              bash $WORKSPACE/tripleo-quickstart/ci-scripts/get-node.sh
              export VIRTHOST=$(head -n1 $WORKSPACE/virthost)
              echo $VIRTHOST

              pushd $WORKSPACE/ci-config

              bash $WORKSPACE/ci-config/ci-scripts/{test}.sh \
                {release} \
                {topology} \
                {job_type} \
                {environment}

              popd

- builder:
    name: 'tripleo-quickstart-upgrade-builder'
    builders:
        - shell: |
              echo "git+https://review.rdoproject.org/r/rdo-infra/ci-config/#egg=ci-conf" >> $WORKSPACE/quickstart-extras-requirements.txt

              bash $WORKSPACE/tripleo-quickstart/ci-scripts/get-node.sh
              export VIRTHOST=$(head -n1 $WORKSPACE/virthost)
              echo $VIRTHOST

              pushd $WORKSPACE/tripleo-quickstart

              bash $WORKSPACE/tripleo-quickstart/ci-scripts/{test}.sh \
                {release} \
                {build_system} \
                {topology} \
                {job_type} \
                {upgrade_delorean_hash} \
                {major_upgrade} \
                {enable_pacemaker} \
                {target_upgrade_version} \
                {environment}

              popd

- builder:
    name: 'tripleo-quickstart-tempest-builder'
    builders:
        - shell: |
              echo "git+https://review.rdoproject.org/r/rdo-infra/ci-config/#egg=ci-conf" >> $WORKSPACE/quickstart-extras-requirements.txt

              # Temporary workaround while https://review.openstack.org/#/c/423340/
              # isn't merged.
              git clone https://github.com/openstack/tripleo-quickstart-extras
              pushd tripleo-quickstart-extras
              git remote add gerrit https://review.openstack.org/openstack/tripleo-quickstart-extras
              git fetch --all
              git review -d I57f5f0928e5efec106c793b71e335af1ac77fa91
              popd

              pushd $WORKSPACE/tripleo-quickstart
              echo "file://$WORKSPACE/tripleo-quickstart-extras/#egg=tripleo-quickstart-extras" > $WORKSPACE/tripleo-quickstart/quickstart-extras-requirements.txt
              popd

              bash $WORKSPACE/tripleo-quickstart/ci-scripts/get-node.sh
              export VIRTHOST=$(head -n1 $WORKSPACE/virthost)
              echo $VIRTHOST

              pushd $WORKSPACE/tripleo-quickstart
              echo "file://$WORKSPACE/tripleo-quickstart-extras/#egg=tripleo-quickstart-extras" > $WORKSPACE/tripleo-quickstart/quickstart-extras-requirements.txt

              export OPT_ADDITIONAL_PARAMETERS=" -e enable_cinder_backup=true -e test_ping=false -e tempest_config=true -e run_tempest=true -e test_regex={test_regex}"

              bash $WORKSPACE/tripleo-quickstart/ci-scripts/{test}.sh \
                {release} \
                {build_system} \
                {topology} \
                {job_type} \
                {environment}

              popd

              # when running tempest, do not fail the job based on the deployment
              # the result will be determined by tempest results file and will go red if it's not present
              exit 0
