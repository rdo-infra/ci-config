- builder:
    name: 'tripleo-quickstart-builder'
    builders:
        - shining-panda:
            build-environment: 'virtualenv'
            python-version: 'system-CPython-2.7'
            nature: 'shell'
            clear: true
            use-distribute: false
            system-site-packages: false
            ignore-exit-code: false
            command: |
              bash $WORKSPACE/tripleo-quickstart/ci-scripts/get-node.sh
              export VIRTHOST=$(head -n1 $WORKSPACE/virthost)
              echo $VIRTHOST

              pushd $WORKSPACE/tripleo-quickstart

              result=0

              bash $WORKSPACE/tripleo-quickstart/ci-scripts/{test}.sh \
                {release} \
                {build_system} \
                {topology} \
                {gate_or_promote} || result=1

              infra_result=0

              bash $WORKSPACE/tripleo-quickstart/ci-scripts/collect-logs.sh &> $WORKSPACE/collect_logs.txt || infra_result=1
              bash $WORKSPACE/tripleo-quickstart/ci-scripts/return-node.sh &> $WORKSPACE/cleanup.txt || infra_result=2

              if [[ "$infra_result" != "0" && "$result" = "0" ]]; then
                # if the job/test was ok, but collect_logs/cleanup failed,
                # print out why the collect_logs/cleanup failed
                cat $WORKSPACE/collect_logs.txt
                cat $WORKSPACE/cleanup.txt
              fi
              exit $result
