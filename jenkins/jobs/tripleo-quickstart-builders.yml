- builder:
    name: 'tripleo-quickstart-builder'
    builders:
        - shell: |
              bash $WORKSPACE/tripleo-quickstart/ci-scripts/get-node.sh
              export VIRTHOST=$(head -n1 $WORKSPACE/virthost)
              echo $VIRTHOST

              pushd $WORKSPACE/tripleo-quickstart

              bash $WORKSPACE/tripleo-quickstart/ci-scripts/{test}.sh \
                {release} \
                {build_system} \
                {topology} \
                {job_type}

              popd

- builder:
    name: 'tripleo-quickstart-tempest-builder'
    builders:
        - shell: |
              bash $WORKSPACE/tripleo-quickstart/ci-scripts/get-node.sh
              export VIRTHOST=$(head -n1 $WORKSPACE/virthost)
              echo $VIRTHOST

              pushd $WORKSPACE/tripleo-quickstart

              export RELEASE={release}
              export BUILD_SYS={build_system}
              export CONFIG={topology}


              anscmd="stdbuf -oL -eL ansible-playbook -vv"
              pushd $WORKSPACE/tripleo-quickstart

              # (trown) This is so that we ensure separate ssh sockets for
              # concurrent jobs. Without this, two jobs running in parallel
              # would try to use the same undercloud-stack socket.
              socketdir=$(mktemp -d /tmp/sockXXXXXX)
              export ANSIBLE_SSH_CONTROL_PATH=$socketdir/%%h-%%r
              export VIRTUAL_ENV_DISABLE_PROMPT=1
              source $WORKSPACE/bin/activate

              cmd="$anscmd -i local_hosts \
                  $WORKSPACE/tripleo-quickstart/playbooks/build-images-and-quickstart.yml \
                  --extra-vars ansible_python_interpreter=/usr/bin/python \
                  --extra-vars virthost=$VIRTHOST \
                  --extra-vars local_working_dir=$WORKSPACE/ \
                  --extra-vars image_url="file:///var/lib/oooq-images/undercloud.qcow2" \
                  --extra-vars artib_release=$RELEASE \
                  --extra-vars artib_build_system=$BUILD_SYS \
                  --extra-vars @$WORKSPACE/tripleo-quickstart/config/general_config/$CONFIG.yml \
                  --extra-vars prepare_tempest=True \
                  --extra-vars test_tempest=True"

              if [[ -n "$DELOREAN_HASH" ]]; then
                  cmd="$cmd -e artib_delorean_hash=$DELOREAN_HASH"
              fi
              $cmd
              popd
