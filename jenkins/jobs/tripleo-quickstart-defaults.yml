- defaults:
    name: 'tripleo-quickstart-defaults'
    description: |
        <p>Managed by Jenkins Job Builder. Do not edit via web.</p>
        <br>
        <p>This job runs the script <a href="https://github.com/openstack/tripleo-quickstart/blob/master/ci-scripts/{test}.sh" target="_blank">{test}.sh</a></p>
        <br>
        In order to run this job locally:
        <pre>

        export VIRTHOST='my-cool-virthost.example.com'

        bash ci-scripts/{test}.sh \
            {release} \
            {build_system} \
            {topology} \
            {job_type}

        </pre>
    concurrent: false
    node: 'rdo'
    logrotate:
        daysToKeep: 5
        artifactDaysToKeep: 5
    publishers:
        - tripleo-quickstart-cleanup
        - tripleo-quickstart-full-logs-link
    wrappers:
        - ansicolor
        - timestamps
        - workspace-cleanup
        - timeout:
            type: absolute
            timeout: 180
            fail: true

# "Building remotely" should always be in the build console output
- publisher:
    name: 'tripleo-quickstart-cleanup'
    publishers:
        - post-tasks:
            - matches:
                - log-text: Building remotely
              escalate-status: false
              shell: |
                pushd $WORKSPACE/tripleo-quickstart
                infra_result=0
                bash $WORKSPACE/tripleo-quickstart/ci-scripts/collect-logs.sh &> $WORKSPACE/collect_logs.txt || infra_result=1
                bash $WORKSPACE/tripleo-quickstart/ci-scripts/return-node.sh &> $WORKSPACE/cleanup.txt || infra_result=2

                if [[ "$infra_result" != "0" && "$result" = "0" ]]; then
                  # if the job/test was ok, but collect_logs/cleanup failed,
                  # print out why the collect_logs/cleanup failed
                  cat $WORKSPACE/collect_logs.txt
                  cat $WORKSPACE/cleanup.txt
                fi
                popd

- publisher:
    name: 'tripleo-quickstart-full-logs-link'
    publishers:
        - archive:
            artifacts: '**/full_logs.html'
