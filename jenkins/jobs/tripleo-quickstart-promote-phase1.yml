# this is just here temporarily to see what weirdo jobs need URLTriggers added
- builder:
    name: phase-test-import-master-current-tripleo
    builders:
        - multijob:
            name: "INSTALL / TEST (IMPORT IMAGES)"
            condition: UNSTABLE
            projects:
                - name: tripleo-quickstart-promote-master-current-tripleo-delorean-minimal
                  kill-phase-on: NEVER
                  property-file: /tmp/delorean_master_current_tripleo_hash
                - name: tripleo-quickstart-promote-master-current-tripleo-delorean-minimal_pacemaker
                  kill-phase-on: NEVER
                  property-file: /tmp/delorean_master_current_tripleo_hash
                - name: weirdo-master-promote-packstack-scenario001
                  kill-phase-on: NEVER
                  property-file: /tmp/delorean_master_current_tripleo_hash
                - name: weirdo-master-promote-packstack-scenario002
                  kill-phase-on: NEVER
                  property-file: /tmp/delorean_master_current_tripleo_hash
                - name: weirdo-master-promote-packstack-scenario003
                  kill-phase-on: NEVER
                  property-file: /tmp/delorean_master_current_tripleo_hash
                - name: weirdo-master-promote-puppet-openstack-scenario001
                  kill-phase-on: NEVER
                  property-file: /tmp/delorean_master_current_tripleo_hash
                - name: weirdo-master-promote-puppet-openstack-scenario002
                  kill-phase-on: NEVER
                  property-file: /tmp/delorean_master_current_tripleo_hash
                - name: weirdo-master-promote-puppet-openstack-scenario003
                  kill-phase-on: NEVER
                  property-file: /tmp/delorean_master_current_tripleo_hash
                - name: weirdo-master-promote-puppet-openstack-scenario004
                  kill-phase-on: NEVER
                  property-file: /tmp/delorean_master_current_tripleo_hash

- builder:
    name: ci-config-checkout
    builders:
      - shell: |
          git clone https://review.rdoproject.org/r/p/rdo-infra/ci-config.git $WORKSPACE/rdo-infra/ci-config

- builder:
    name: get-hash
    builders:
      - shell: |
          export RELEASE={release}
          export PROMOTE_NAME={promote_name}
          bash -xe $WORKSPACE/rdo-infra/ci-config/ci-scripts/tripleo-upstream/get-hash.sh

- publisher:
    name: 'tripleo-quickstart-report-dlrn-api'
    publishers:
        - post-tasks:
            - matches:
                - log-text: marked build as failure
              script: |
                export JOB_SUCCESS=false
                bash -xe $WORKSPACE/rdo-infra/ci-config/ci-scripts/tripleo-upstream/dlrn-api-report.sh
        - post-tasks:
            - matches:
                - log-text: Virtual Environment Setup Complete
              run-if-job-successful: true
              script: |
                export JOB_SUCCESS=false
                bash -xe $WORKSPACE/rdo-infra/ci-config/ci-scripts/tripleo-upstream/dlrn-api-report.sh

- job-template:
    name: 'tripleo-quickstart-promote-{release}-rdo_trunk-{topology}'
    defaults: 'tripleo-quickstart-promote-defaults'
    triggers:
        - pollurl:
            cron: "H * * * *"
            urls:
                - url: https://trunk-primary.rdoproject.org/centos7-{release}/current-tripleo/delorean.repo
                  check-content:
                    - simple: true
    scm:
        - repo-tripleo-quickstart
    builders:
        - ci-config-checkout
        - get-hash:
            release: '{release}'
            promote_name: 'current-tripleo'
        - tripleo-quickstart-builder:
            test: '{test}'
            job_type: '{job_type}'
            release: '{release}'
            build_system: '{build_system}'
            topology: '{topology}'
    publishers:
        - tripleo-quickstart-cleanup:
            topology: '{topology}'
            job_type: '{job_type}'
        - tripleo-quickstart-full-logs-link
        - tripleo-quickstart-report-dlrn-api

- project:
    name: 'tripleo-quickstart-promote-master-current-tripleo-jobs'
    test: 'full-deploy'
    job_type: 'promote'
    release:
        - 'newton'
        - 'ocata'
        - 'pike'
        - 'master'
    build_system: 'rdo_trunk'
    topology:
        - 'minimal'
        - 'minimal_pacemaker'
    jobs:
        - 'tripleo-quickstart-promote-{release}-rdo_trunk-{topology}'
