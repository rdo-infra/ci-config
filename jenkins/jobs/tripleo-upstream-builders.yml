- builder:
    name: 'tripleo-upstream-setup-roles'
    builders:
        - shell: |
            WORKSPACE="${WORKSPACE:-/tmp}"
            CICO_USER_DIR="${CICO_USER_DIR:-/root}"

            # Workaround to ensure skydive container, which isn't supported on ppc64le, doesn't build
            cat <<EOF >> ${WORKSPACE}/tripleo-ci/roles/build-containers/tasks/venv_setup.yml

            - name: Remove skydive from kolla
              file:
                path: "${CICO_USER_DIR}/workspace/venv_build/share/kolla/docker/skydive"
                state: absent

            - name: Remove tempest from kolla
              file:
                path: "${CICO_USER_DIR}/workspace/venv_build/share/kolla/docker/tempest"
                state: absent
            EOF

            # Place roles for the tripleo-ci container build playbooks in the proper directory
            mkdir ${WORKSPACE}/roles
            cp -r ${WORKSPACE}/tripleo-ci/roles/* ${WORKSPACE}/roles
            cp -r ${WORKSPACE}/tripleo-ansible/roles/* ${WORKSPACE}/roles
            git clone https://github.com/openstack/ansible-role-bindep \
                ${WORKSPACE}/roles/bindep
            git clone https://github.com/openstack/ansible-role-container-registry \
                ${WORKSPACE}/roles/ansible-role-container-registry

            # Copy over any zuul roles needed
            cp -r ${WORKSPACE}/zuul-jobs/roles/ensure-pip ${WORKSPACE}/roles

            # Mock prerequisite zuul vars so the playbooks can run on jenkins
            cat <<EOF >> ${WORKSPACE}/roles/build-containers/vars/main.yaml

            zuul:
              projects:
                opendev.org/openstack/tripleo-repos:
                  src_dir: "src/opendev.org/openstack/tripleo-repos"
                opendev.org/openstack/python-tripleoclient:
                  src_dir: "src/opendev.org/openstack/python-tripleoclient"
              branch: "master"
              pipeline: "periodic"

            push_containers: true
            push_registry: trunk.registry.rdoproject.org
            use_buildah: "true"
            build_timeout: 7200
            EOF

            cat <<EOF >> ${WORKSPACE}/roles/tripleo-repos/vars/main.yml

            zuul:
              branch: master
              projects:
                opendev.org/openstack/tripleo-repos:
                  src_dir: "src/opendev.org/openstack/tripleo-repos"
                opendev.org/openstack/python-tripleoclient:
                  src_dir: "src/opendev.org/openstack/python-tripleoclient"
            EOF

- builder:
    name: 'tripleo-upstream-build-containers'
    builders:
         - shell: |
            WORKSPACE="${WORKSPACE:-/tmp}"
            CICO_USER_DIR="${CICO_USER_DIR:-/root}"
            VENV="${WORKSPACE}/venv"
            OPENSTACK_GIT_URL="https://opendev.org/openstack"
            RELEASE="${RELEASE:-master}"
            RDO_CONFIG_DIR="${RDO_CONFIG_DIR:-src/rdo-infra/ci-config}"
            RDO_CONFIG_DIR_PROTECTED="${RDO_CONFIG_DIR_PROTECTED:-src/rdo-infra/review.rdoproject.org-config}"

            [[ ! -d "${VENV}" ]] && virtualenv "${VENV}"
            source "${VENV}/bin/activate"

            # Install requirements.
            # Pin to version used by tripleo-quickstart as of this commit.
            pip install ansible==2.8.0

            # We keep connecting onto the same hosts that are continuously reinstalled
            export ANSIBLE_HOST_KEY_CHECKING=False

            # cat the playbook for building containers to the workspace
            cat << EOF > ${WORKSPACE}/containers-build.yml
            ---
            - name: 'Setup CICO node for container builds'
              hosts: openstack_nodes
              become: yes
              tasks:
                - name: 'Install dependencies with dnf'
                  package:
                    name:
                      - 'buildah'
                      - 'git'
                      - 'iptables'
                      - 'libffi'
                      - 'libffi-devel'
                      - 'openssl'
                      - 'openssl-devel'
                      - 'podman'
                      - 'python3-pip'
                      - 'python3-virtualenv'
                      - 'rsync'
                      - '@Development Tools'
                    state: present

                - name: 'Install pip requirement'
                  pip:
                    name: 'ansible==2.8.0'

                - name: 'Install decorator - Deliberately clobber decorator system site package with working version'
                  pip:
                    name: 'decorator'
                    extra_args: '-I'

                - name: 'Create openstack iptables chain and jump rule'
                  shell: |
                    iptables -N openstack-INPUT
                    iptables -I INPUT 1 -j openstack-INPUT

                - name: 'Remove all container registries except for docker.io, which serves power containers'
                  shell: |
                    sed -i "s/.*registry.centos.org.*/registries = ['docker.io']/g" /etc/containers/registries.conf

            - name: 'Clone OpenStack git dependencies'
              hosts: openstack_nodes
              tasks:
                - name: 'Clone git dependency'
                  git:
                    repo: '${OPENSTACK_GIT_URL}/{{ item }}.git'
                    dest: '${CICO_USER_DIR}/src/opendev.org/openstack/{{ item }}'
                  with_items:
                    - 'ansible-role-container-registry'
                    - 'kolla'
                    - 'python-tripleoclient'
                    - 'requirements'
                    - 'tripleo-ansible'
                    - 'tripleo-common'
                    - 'tripleo-repos'

            - name: 'Clone RDO git dependencies, protected repo'
              hosts: openstack_nodes
              tasks:
                - name: 'Clone rdo-infra/review.rdoproject.org-config'
                  git:
                     repo: 'https://github.com/rdo-infra/review.rdoproject.org-config.git'
                     dest: '${CICO_USER_DIR}/${RDO_CONFIG_DIR_PROTECTED}'

            - name: 'Clone RDO git dependencies'
              hosts: openstack_nodes
              tasks:
                - name: 'Clone rdo-infra/review.rdoproject.org-config'
                  git:
                     repo: 'https://github.com/rdo-infra/ci-config.git'
                     dest: '${CICO_USER_DIR}/${RDO_CONFIG_DIR}'

            - name: 'Login to RDO registry'
              hosts: openstack_nodes
              tasks:
                - when: push_containers|default(true)|bool
                  block:
                    - shell: |-
                        buildah login --username=tripleo.service \
                                     --password="${RDO_REGISTRY_TOKEN}" \
                                     "https://trunk.registry.rdoproject.org"
                    - shell: |-
                        sudo buildah login --username=tripleo.service \
                                     --password="${RDO_REGISTRY_TOKEN}" \
                                     "https://trunk.registry.rdoproject.org"
                  no_log: true

            - name: Populate hash.info required for dlrn reporting
              hosts: openstack_nodes
              tasks:
                - shell: |
                      pushd "${CICO_USER_DIR}"
                        export WORKSPACE="${CICO_USER_DIR}/workspace"
                        export RELEASE="${RELEASE}"
                        export PROMOTE_NAME="tripleo-ci-testing"
                        export DLRNAPI_DISTRO={{ ansible_distribution }}
                        export DLRNAPI_DISTRO_VERSION={{ ansible_distribution_major_version }}
                        bash -xe "${CICO_USER_DIR}/${RDO_CONFIG_DIR}/ci-scripts/tripleo-upstream/get-hash.sh"
                      popd

            - name: 'Setup TripleO Container Registry and repos mirror'
              hosts: openstack_nodes
              roles:
                - role: tripleo-repos
                  override_repos: "tripleo-ci-testing"
                  tripleo_repos_repository: "${CICO_USER_DIR}/{{ zuul.projects['opendev.org/openstack/tripleo-repos'].src_dir }}"
                - role: bindep
                  bindep_dir: "${CICO_USER_DIR}/{{ zuul.projects['opendev.org/openstack/python-tripleoclient'].src_dir }}"
              tasks:
                - name: Run build containers pre tasks
                  include_role:
                    name: build-containers
                    tasks_from: pre

            - name: 'Build TripleO Containers'
              hosts: openstack_nodes
              tasks:
                - block:
                    - name: Run build containers tasks
                      include_role:
                        name: build-containers
                    - name: Report success
                      debug:
                        msg: Container build and upload succeeded
                  rescue:
                    - name: Report failure
                      fail:
                        msg: Container build and upload failed
            EOF

            # cico-get-node requests a duffy node and generates an ansible-compatible
            # inventory at $WORKSPACE/hosts
            ansible-playbook --ssh-extra-args="-o UserKnownHostsFile=/dev/null" -vvv -i "${WORKSPACE}/hosts" "${WORKSPACE}/containers-build.yml"

- builder:
    name: 'tripleo-upstream-build-images'
    builders:
         - shell: |
            WORKSPACE="${WORKSPACE:-/tmp}"
            CICO_USER_DIR="${CICO_USER_DIR:-/root}"
            VENV="${WORKSPACE}/venv"
            OPENSTACK_GIT_URL="https://opendev.org/openstack"
            RELEASE="${RELEASE:-master}"
            RDO_CONFIG_DIR="${RDO_CONFIG_DIR:-src/rdo-infra/ci-config}"
            RDO_CONFIG_DIR_PROTECTED="${RDO_CONFIG_DIR_PROTECTED:-src/rdo-infra/review.rdoproject.org-config}"

            [[ ! -d "${VENV}" ]] && virtualenv "${VENV}"
            source "${VENV}/bin/activate"

            # Install requirements.
            # Pin to version used by tripleo-quickstart as of this commit.
            pip install ansible==2.8.0

            # We keep connecting onto the same hosts that are continuously reinstalled
            export ANSIBLE_HOST_KEY_CHECKING=False

            # opstools workaround
            sed -i 's/opstools//' ${WORKSPACE}/roles/tripleo-repos/tasks/main.yml

            # cat the playbook for building images to the workspace
            cat << EOF > ${WORKSPACE}/images-build.yml
            ---
            - name: 'Setup CICO node for disk image builds'
              hosts: openstack_nodes
              become: yes
              tasks:
                - name: 'Install dependencies with dnf'
                  package:
                    name:
                      - 'git'
                      - 'openssl'
                      - 'openssl-devel'
                      - 'python3-pip'
                      - 'python3-virtualenv'
                      - 'rsync'
                      - '@Development Tools'
                    state: present

                - name: 'Install pip requirement'
                  pip:
                    name: 'ansible==2.8.0'

                - name: 'Install decorator - Deliberately clobber decorator system site package with working version'
                  pip:
                    name: 'decorator'
                    extra_args: '-I'

            - name: 'Clone OpenStack git dependencies'
              hosts: openstack_nodes
              tasks:
                - name: 'Clone git dependency'
                  git:
                    repo: '${OPENSTACK_GIT_URL}/{{ item }}.git'
                    dest: '${CICO_USER_DIR}/src/opendev.org/openstack/{{ item }}'
                  with_items:
                    - 'ansible-role-container-registry'
                    - 'diskimage-builder'
                    - 'heat-agents'
                    - 'ironic-python-agent-builder'
                    - 'python-tripleoclient'
                    - 'tripleo-common'
                    - 'tripleo-image-elements'
                    - 'tripleo-puppet-elements'
                    - 'tripleo-repos'
                    - 'requirements'

            - name: 'Workaround to avoid biosdevname dependency'
              hosts: openstack_nodes
              tasks:
                - name: 'Remove any usage of stable-interface-names element'
                  lineinfile:
                    path: "{{ item }}"
                    regexp: ".*stable-interface-names.*"
                    state: absent
                  with_fileglob:
                    - "${CICO_USER_DIR}/src/opendev.org/openstack/tripleo-common/image-yaml/*.yaml"

            - name: 'Clone RDO git dependencies, protected repo'
              hosts: openstack_nodes
              tasks:
                - name: 'Clone rdo-infra/review.rdoproject.org-config'
                  git:
                     repo: 'https://github.com/rdo-infra/review.rdoproject.org-config.git'
                     dest: '${CICO_USER_DIR}/${RDO_CONFIG_DIR_PROTECTED}'

            - name: 'Clone RDO git dependencies'
              hosts: openstack_nodes
              tasks:
                - name: 'Clone rdo-infra/review.rdoproject.org-config'
                  git:
                     repo: 'https://github.com/rdo-infra/ci-config.git'
                     dest: '${CICO_USER_DIR}/${RDO_CONFIG_DIR}'

            - name: 'Pre-tasks for TripleO image builds'
              hosts: openstack_nodes
              roles:
                - role: tripleo-repos
                  override_repos: "{{ buildcontainers_override_repos | default('') }}"
                  tripleo_repos_repository: "${CICO_USER_DIR}/{{ zuul.projects['opendev.org/openstack/tripleo-repos'].src_dir }}"
                - role: bindep
                  bindep_dir: "${CICO_USER_DIR}/{{ zuul.projects['opendev.org/openstack/python-tripleoclient'].src_dir }}"
              tasks:
                - name: Run build images pre tasks
                  include_role:
                    name: oooci-build-images
                    tasks_from: pre

            - name: 'Build TripleO Images'
              hosts: openstack_nodes
              tasks:
                - block:
                    - name: Run build images tasks
                      include_role:
                        name: oooci-build-images
                    - name: Report success
                      debug:
                        msg: Container build and upload succeeded
                  rescue:
                    - name: Report failure
                      fail:
                        msg: Container build and upload failed
            EOF

            # cico-get-node requests a duffy node and generates an ansible-compatible
            # inventory at $WORKSPACE/hosts
            ansible-playbook --ssh-extra-args="-o UserKnownHostsFile=/dev/null" -vvv -i "${WORKSPACE}/hosts" "${WORKSPACE}/images-build.yml"
