- builder:
    name: 'weirdo-get-node'
    builders:
        - shell:
            !include-raw:
                - scripts/weirdo-vars.sh
                - scripts/cico-node-get-to-ansible.sh

- builder:
    name: 'weirdo-ansible-playbook-builder'
    builders:
        - shell: |
            if [[ "{openstack_release}" != "master" ]]; then
                version="stable/{openstack_release}"
            else
                version="{openstack_release}"
            fi

            # Use WeIRDO provided by jenkins scm
            export ARA_DATABASE="sqlite:///$WORKSPACE/$JOB_NAME.sqlite"
            cd weirdo
            git log -n 5 --oneline

            tox -e ansible-playbook -- -vv -i hosts playbooks/remove-firewalld-networkmanager.yml
            tox -e ansible-playbook -- -vv -i hosts playbooks/{playbook}.yml -e ci_environment=ci-centos -e openstack_release={openstack_release} -e version=$version

- builder:
    name: 'weirdo-generic-ansible-playbook-builder'
    builders:
        - shell: |
            # If a properties file is specified, it should overwrite and have priority over other parameters
            if [[ -n "${{properties}}" ]]; then
              curl -s -O ${{properties}}
              source "./$(basename ${{properties}})"
            fi

            # Use WeIRDO provided by jenkins scm
            export ARA_DATABASE="sqlite:///$WORKSPACE/$JOB_NAME.sqlite"
            cd weirdo
            git log -n 5 --oneline

            tox -e ansible-playbook -- -vv -i hosts playbooks/remove-firewalld-networkmanager.yml
            tox -e ansible-playbook -- -vv -i hosts playbooks/{playbook}.yml -e ci_environment=ci-centos -e delorean_url=${{delorean_url}} -e delorean_deps_url=${{delorean_deps_url}} -e version=${{version}}

- builder:
    name: 'weirdo-promote-ansible-playbook-builder'
    builders:
        - shell: |
            if [[ "{openstack_release}" != "master" ]]; then
                version="stable/{openstack_release}"
            else
                version="{openstack_release}"
            fi

            # Use variables provided by a job earlier in the pipeline, if available
            delorean_hash=${{delorean_current_hash:-current}}
            delorean_url="http://trunk.rdoproject.org/centos7-{openstack_release}/${{delorean_hash}}/delorean.repo"

            # Use WeIRDO provided by jenkins scm
            export ARA_DATABASE="sqlite:///$WORKSPACE/$JOB_NAME.sqlite"
            cd weirdo
            git log -n 5 --oneline

            tox -e ansible-playbook -- -vv -i hosts playbooks/remove-firewalld-networkmanager.yml
            tox -e ansible-playbook -- -vv -i hosts playbooks/{playbook}.yml -e ci_environment=ci-centos -e delorean_url=$delorean_url -e openstack_release={openstack_release} -e version=$version

- builder:
    name: 'weirdo-generate-log-redirection'
    builders:
        - shell: |
            ARTIFACT_URL="https://ci.centos.org/artifacts/rdo"

            cat << EOF > "${WORKSPACE}/logs.html"
            <!DOCTYPE HTML>
            <html lang="en-US">
                <head>
                    <meta charset="UTF-8">
                    <meta http-equiv="refresh" content="1;url=${ARTIFACT_URL}/${JOB_NAME}/${BUILD_NUMBER}">
                    <script type="text/javascript">
                        window.location.href = "${ARTIFACT_URL}/${JOB_NAME}/${BUILD_NUMBER}"
                    </script>
                    <title>Redirection to logs</title>
                </head>
                <body>
                    If you are not redirected automatically, follow the <a href="${ARTIFACT_URL}/${JOB_NAME}/${BUILD_NUMBER}">link to the logs</a>.
                </body>
            </html>
            EOF
