- defaults:
    name: 'weirdo-defaults'
    description: |
        Managed by Jenkins Job Builder. Do not edit via web.
    concurrent: false
    node: 'rdo-virtualized'
    logrotate:
        daysToKeep: 31
        artifactDaysToKeep: 31
    publishers:
        - weirdo-email-cores
        - weirdo-archive-logs
    wrappers:
        - ansicolor
        - timestamps
        - workspace-cleanup
        - timeout:
            type: absolute
            timeout: 120
            fail: true
    tempest_version: ''

- defaults:
    name: 'weirdo-promote-defaults'
    description: |
        Managed by Jenkins Job Builder. Do not edit via web.
    concurrent: false
    node: 'rdo-promote-virtualized'
    logrotate:
        daysToKeep: 31
        artifactDaysToKeep: 31
    publishers:
        - weirdo-email-cores
        - weirdo-archive-logs
    wrappers:
        - ansicolor
        - timestamps
        - workspace-cleanup
        - timeout:
            type: absolute
            timeout: 120
            fail: true

- publisher:
    name: 'weirdo-email-cores'
    publishers:
        - email:
            recipients: 'dms@redhat.com'

- publisher:
    name: 'weirdo-archive-logs'
    publishers:
        - archive:
            artifacts: 'properties,logs.html'
            allow-empty: true

# "Building remotely" should always be in the build console output
- publisher:
    name: 'weirdo-release-node'
    publishers:
        - post-tasks:
            - matches:
                - log-text: Building remotely
              script:
                !include-raw:
                    - scripts/weirdo-collect-logs.sh
                    - scripts/cico-node-done-from-ansible.sh

# "Building remotely" should always be in the build console output
- publisher:
    name: 'weirdo-destroy-vm'
    publishers:
        - post-tasks:
            - matches:
                - log-text: Building remotely
              script:
                !include-raw:
                    - scripts/weirdo-destroy-vm.sh

# "Building remotely" should always be in the build console output
- publisher:
    name: 'weirdo-report-dlrn-api'
    publishers:
        - post-tasks:
            - matches:
                - log-text: Building remotely
              run-if-job-successful: true
              script: |
                # Use variables provided by a job earlier in the pipeline, if available
                delorean_hash=${{delorean_current_hash:-current}}
                delorean_commit_url="http://trunk-primary.rdoproject.org/centos7-${{RDO_VERSION_DIR}}/${{delorean_hash}}/commit.yaml"
                if [[ "${{RDO_VERSION_DIR}}" == "master" ]]; then
                    api_worker="api-centos-master-uc"
                else
                    api_worker="api-centos-${{RDO_VERSION_DIR}}"
                fi
                api_url="http://trunk-primary.rdoproject.org/api-$api_worker"
                commit_hash=$(echo $delorean_hash | awk -F/ '{{print $3}}' |awk -F_ '{{print $1}}')
                distro_hash=`curl $delorean_commit_url | grep distro_hash |  awk -F: '{{print $2}}' |xargs echo`
                info_url="https://ci.centos.org/artifacts/rdo/${{JOB_NAME}}/${{BUILD_NUMBER}}"
                timestamp=`date +%s`

                # Install dependencies
                [[ ! -d report_venv ]] && virtualenv report_venv
                source report_venv/bin/activate
                pip install git+https://github.com/javierpena/dlrnapi_client

                # Report
                # DLRNAPI_USER and DLRNAPI_PASSWD are set as part of JJB / jenkins config
                dlrnapi --url $api_url -u $DLRNAPI_USER -p $DLRNAPI_PASSWD report-result \
                --job-id $JOB_NAME --commit-hash $commit_hash --distro-hash $distro_hash \
                --info-url $info_url --timestamp $timestamp --success true
