- hosts: instance
  tasks:
    - name: "Ensure Credentials"
      include_role:
        name: _ensure_credentials

    - name: "Run promoter role"
      include_role:
        name: promoter

    - name: "Create promoter log dirs"
      file:
        path: "{{ item }}"
        state: directory
      with_items:
        - "{{ promoter_logs }}"

    - name: "Setup registry"
      include_tasks: setup_registry.yml

    - name: "Get master containers list"
      get_url:
        url: "https://opendev.org/openstack/tripleo-common/raw/branch/master/container-images/tripleo_containers.yaml"
        dest: "/var/tmp/promoter_logs/tripleo_containers.yaml"

    - name: "Get all container names" # noqa 505
      include_vars:
        file: "/var/tmp/promoter_logs/tripleo_containers.yaml"
        name: c_list

    - name: "Create containers list"
      set_fact:
        tmp_c_list: []

    - name: "Add container names to list"
      no_log: true
      set_fact:
        tmp_c_list: "{{ tmp_c_list + [item['imagename'].split('/')[-1].split(':')[0] | replace('openstack-', '')] }}"
        cacheable: yes
      with_items: "{{ c_list.container_images }}"

    - name: "COntainers list"
      debug:
        var: tmp_c_list

    - name: "Remove invalid containers"
      set_fact:
        containers_list: "{{ tmp_c_list | difference(invalid_containers) | list }}"
        cacheble: yes

    - name: "Print after"
      debug:
        var: containers_list
