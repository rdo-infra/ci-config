---
- hosts: instance
  tasks:

    # include_vars only work from controller
    - name: fetch setup-info from remote
      fetch:
        src: "/tmp/stage-info.yaml"
        dest: "/tmp/"
        flat: yes

    - name: include stage setup variables # noqa 505
      include_vars:
        file: "/tmp/stage-info.yaml"
        name: stage_info

    - name: Set full hash
      set_fact:
        full_hash: "{{ stage_info.dlrn.promotions.promotion_candidate.full_hash }}"
        images_path: "{{ stage_info.overcloud_images.root }}"

    - name: Run the image promotion script promote-images.sh # noqa 301
      shell: |
         source /home/{{ promoter_user }}/promoter_venv/bin/activate
         {{ ci_config_remote_src_dir }}/ci-scripts/promote-images.sh master {{ full_hash }} tripleo-ci-staging-promoted
      register: promote_images_result # need to check this as sftp can fail
