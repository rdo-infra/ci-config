# Setup the promoter-staging environment (--scenes 'overcloud-images')
- hosts: instance
  vars:
    staging_action: setup
  tasks:
    - name: Setup local loop device as docker partition
      include_role:
        name: promoter
        tasks_from: setup_loop

    - name: Run promotion server provisioning role
      include_role:
        name: promoter
        tasks_from: install_packages

    - name: Ensure promoter user exists
      become: true
      user:
        name: "{{ promoter_user }}"
        system: true
        create_home: true

    - name: Ensure credentials are created
      include_role:
        name: _ensure_credentials

    - name: Setup staging environment
      shell: |
        python3 stage.py {{ staging_action }} {{ staging_args }}
      args:
        chdir: "{{ ci_config_remote_src_dir }}/ci-scripts/dlrnapi_promoter"
      changed_when: false
