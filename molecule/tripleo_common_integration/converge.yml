---
- hosts: instance
  tasks:
    # image prepare pulls from promote_registry and pushes to undercloud_registry
    - name: run container image prepare
      become: true
      become_user: "{{ promoter_user }}"
      shell: |
        source ~/{{ promoter_virtualenv }}/bin/activate
        openstack tripleo container image prepare --verbose \
            -e /tmp/staging-containers-prepare-parameter.yaml \
            --output-env-file /tmp/containers-default-parameters.yaml \
            --roles-file /tmp/tripleo-heat-templates/roles_data.yaml \
            2>&1 > /tmp/tripleo-container-image.prepare.log
      changed_when: true
      environment:
        SUDO_USER: "{{ promoter_user }}"
        ANSIBLE_PYTHON_INTERPRETER: "~/{{ promoter_virtualenv }}/bin/python3"
        ANSIBLE_LIBRARY: "~/{{ promoter_virtualenv }}/share/ansible/plugins/modules"
        ANSIBLE_FILTER_PLUGINS: "~/{{ promoter_virtualenv }}/share/ansible/plugins/filter"
        ANSIBLE_CALLBACK_PLUGINS: "~/{{ promoter_virtualenv }}/share/ansible/plugins/callback"
        ANSIBLE_MODULE_UTILS: "~/{{ promoter_virtualenv }}/share/ansible/plugins/module_utils"
        ANSIBLE_LOG_PATH: "~/ansible.log"
