---
- hosts: all
  vars:
    promoter_user: promoter
    promoter_virtualenv: promoter_venv
  roles:
    - bindep  # python3-libselinux and alike
  tasks:

    # molecule delegated scenarios assume tester/instance host names are the
    # the ones used for testing, use of "localhost" being seen as an
    # anti-pattern which prevents development testing.
    - name: Assure instance or tester point to 127.0.0.1
      become: true
      lineinfile:
        path: /etc/hosts
        line: "127.0.0.1 instance tester"
        state: present

    - name: Run dnf update and install python3
      when: ansible_distribution_major_version | int >= 8
      raw: "{{ item }}"
      loop:
        - sudo dnf -y update
        - sudo dnf -y install python3 gcc python3-devel
      changed_when: true

    - name: "Run dnf update and install python"
      when: ansible_distribution_major_version | int == 7
      raw: "{{ item }}"
      loop:
        - sudo yum -y update
        - sudo yum -y install python gcc python2-devel
      changed_when: true

    - name: "Add tripleo group and users"
      become: true
      block:
        - name: Create tripleo group
          group:
            name: tripleo
            state: present

        - name: Create users
          user:
            name: "{{ promoter_user }}"
            shell: /bin/bash
            groups: tripleo
            system: true
            create_home: true

        - name: Allow 'tripleo' group to have passwordless sudo
          lineinfile:
            dest: /etc/sudoers
            state: present
            line: '%tripleo ALL=(ALL) NOPASSWD: ALL'
            validate: 'visudo -cf %s'

    - name: "Install tripleo projects"
      become: true
      become_user: "{{ promoter_user }}"
      vars:
        ansible_python_interpreter: "/usr/bin/python3"
      when: zuul is defined
      block:
        - name: "Install tripleo-common from zuul"
          pip:
            name: "file://{{ zuul.executor.src_root }}/{{ zuul.projects['opendev.org/openstack/tripleo-common'].canonical_name }}"
            virtualenv: "~/{{ promoter_virtualenv }}"
            state: forcereinstall
          when: "'opendev.org/openstack/tripleo-common' in zuul.projects"

        - name: "Install python-tripleoclient from zuul"
          pip:
            name: "file://{{ zuul.executor.src_root }}/{{ zuul.projects['opendev.org/openstack/python-tripleoclient'].canonical_name }}"
            virtualenv: "~/{{ promoter_virtualenv }}"
            state: forcereinstall
          when: "'opendev.org/openstack/python-tripleoclient' in zuul.projects"

        - name: "Install tripleo-ansible from zuul"
          pip:
            name: "file://{{ zuul.executor.src_root }}/{{ zuul.projects['opendev.org/openstack/tripleo-ansible'].canonical_name }}"
            virtualenv: "~/{{ promoter_virtualenv }}"
            state: forcereinstall
          when: "'opendev.org/openstack/tripleo-ansible' in zuul.projects"
