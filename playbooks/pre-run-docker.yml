---
- hosts: all
  vars:
    docker_group: docker
    target_user: "{{ ansible_user | default(lookup('pipe', 'whoami')) }}"
  tasks:

    # until docker-install role on redhat distros is fixed by:
    # https://review.openstack.org/#/c/634934

    - name: create docker group
      become: true
      group:
        name: "{{ docker_group }}"
        system: true

    - name: Add user to docker group
      become: true
      user:
        name: "{{ target_user }}"
        groups:
          - "{{ docker_group | default('docker') }}"
      register: user_info

    - name: Create user config dir
      file:
        path: "{{ user_info.home }}/.docker/"
        owner: "{{ user_info.name }}"
        state: directory

    - name: Enable experimental commands in user config
      copy:
        content: |
          {
              "experimental": "enabled"
          }
        dest: "{{ user_info.home }}/.docker/config.json"

    - include_role:
        name: ensure-docker
      vars:
        use_upstream_docker: true
