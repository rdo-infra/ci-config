[tox]
minversion = 1.6
envlist = py27, molecule
skipdist = True

[testenv]
usedevelop = True
install_command = pip install -U {opts} {packages}
setenv =
    VIRTUAL_ENV={envdir}
    ANSIBLE_STDOUT_CALLBACK=debug
    ANSIBLE_CALLBACK_WHITELIST=timer,profile_roles
    ANSIBLE_FORCE_COLOR=1
passenv =
    CURL_CA_BUNDLE
    FTP_PROXY
    HTTPS_PROXY
    HTTP_PROXY
    NO_PROXY
    REQUESTS_CA_BUNDLE
    ftp_proxy
    http_proxy
    https_proxy
    MOLECULE_*
    ANSIBLE_*
    DOCKER_*
deps = -r{toxinidir}/test-requirements.txt
whitelist_externals =
    bash
    docker
    echo

[testenv:linters]
whitelist_externals =
  rm
  touch
commands =
  # NOTE(pabelanger): We create a dummy token to keep JJB happy.
  touch {toxinidir}/jenkins/jobs/weirdo_token
  jenkins-jobs test {toxinidir}/jenkins/jobs
  rm {toxinidir}/jenkins/jobs/weirdo_token

[testenv:venv]
commands = {posargs}

[testenv:pep8]
changedir = ci-scripts/infra-setup/roles/rrcockpit
whitelist_externals = bash
commands = flake8 --max-line-length 80

[testenv:py27]
deps=
    {[testenv]deps}
    -r{toxinidir}/ci-scripts/dlrnapi_promoter/requirements.txt
changedir = ci-scripts/dlrnapi_promoter
commands = pytest -vv

[testenv:py36]
deps={[testenv:py27]deps}
changedir = {[testenv:py27]changedir}
commands = {[testenv:py27]commands}

[testenv:molecule]
# molecule needs selinux from system
sitepackages = true
changedir = {toxinidir}
setenv =
    {[testenv]setenv}
    _MOLECULE_PLATFORM=centos
    _MOLECULE_DOCKER_IMAGE=centos:7
commands =
    # validate that docker works to avoid more cryptic errors later
    docker ps
    molecule {posargs:test --all}
