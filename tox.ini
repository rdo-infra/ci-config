[tox]
minversion = 1.6
envlist = linters,py27,py36,jjb
skipdist = True
ignore_basepython_conflict = True
skip_missing_interpreters = True

[testenv]
usedevelop = True
install_command = pip install -U {opts} {packages}
setenv =
    ANSIBLE_FORCE_COLOR=1
    ANSIBLE_INVENTORY={toxinidir}/test/hosts.ini
    ANSIBLE_NOCOWS=1
    ANSIBLE_RETRY_FILES_ENABLED=0
    ANSIBLE_STDOUT_CALLBACK=debug
    ANSIBLE_VERBOSITY={env:ANSIBLE_VERBOSITY:1}
    MOLECULE_DEBUG={env:MOLECULE_DEBUG:1}
    MOLECULE_NO_LOG={env:MOLECULE_NO_LOG:false}
    PY_COLORS=1
    VIRTUAL_ENV={envdir}
passenv =
    ANSIBLE_*
    DOCKER_*
    MOLECULE_*
    SSH_AUTH_SOCK
    TERM
deps =
    -r{toxinidir}/test-requirements.txt
    -r{toxinidir}/ci-scripts/dlrnapi_promoter/requirements.txt
    -r{toxinidir}/ci-scripts/infra-setup/roles/rrcockpit/files/telegraf/requirements.txt
commands =
    # install selinux shim package into virtualenv to avoid ansible errors
    pip install "selinux; 'linux' in sys_platform"
    pytest -vv -n auto --html={envlogdir}/reports.html --self-contained-html

[testenv:venv]
commands = {posargs}

[testenv:jjb]
sitepackages = false
whitelist_externals =
  rm
  touch
commands =
  # NOTE(pabelanger): We create a dummy token to keep JJB happy.
  touch {toxinidir}/jenkins/jobs/weirdo_token
  jenkins-jobs test {toxinidir}/jenkins/jobs
  rm {toxinidir}/jenkins/jobs/weirdo_token

[testenv:linters]
commands =
  python -m pre_commit run -a
