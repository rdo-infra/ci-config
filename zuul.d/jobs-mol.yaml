- job:
    name: mol
    abstract: true
    nodeset: rdo-centos-7
    vars:
      # longer -k match avoids accidental inclusion of more than one scenario
      # molecule/ at the end tells pytest to look only inside this folder, so
      # it will avoid collecting (or failign to collect) other unrelated tests
      tox_extra_args: "-- molecule/{{ mol_scenario }}/molecule.yml"
      tox_environment:
        # See https://click.palletsprojects.com/en/7.x/python3/
        LC_ALL: en_US.utf8
        LANG: en_US.utf8
        # assure we fail if we do not pass exactly 1 test, not less or more
        PYTEST_REQPASS: 1
        # forces scenarios to use delegated driver
        MOLECULE_DRIVER_NAME: delegated
        # ^ apparently pytest does not pass above value to molecule, so:
        MOLECULE_OPTS: --driver-name delegated
      # avoids an error with "Run tox without tests" due to implicit use of 'venv' in zuul-job
      tox_envlist: molecule
    # pre assures instance/tester hostnames resolve
    pre-run: playbooks/mol/pre.yml
    # Our run avoids calling revoke-sudo
    run: playbooks/mol/run.yml
    # custom post will make reports.html visible in zuul UI
    post-run: playbooks/mol/post.yml

- job:
    name: mol-promoter
    description: Tests promoter deployment role.
    parent: mol
    vars:
      mol_scenario: promoter
    files:
      - .*promoter.*
      - ^requirements.txt
      - ^setup.cfg
      - ^setup.py
      - ^test-requirements.txt
      - ^tox.ini

- job:
    name: mol-promoter-tripleo-common
    parent: mol
    nodeset: rdo-centos-7
    vars:
      mol_scenario: promoter-tripleo-common
    # TODO:
    #   molecule_test_commands: |
    # # container-push generates staging containers, skip teardown
    # molecule converge -s container-push -- --skip-tags=registry_cleanup
    # # tripleo-common test w/ staging containers
    # molecule test -s tripleo-common-integration
    # # container-push teardown, cleanup registries
    # molecule converge -s container-push -- --tags=registry_cleanup
    files:
      - .*promoter.*
      - ^ci-scripts/dlrnapi_promoter/.*
      - ^ci-scripts/container-push/.*
      - ^molecule/promoter-tripleo-common/.*
      - ^requirements.txt
      - ^test-requirements.txt

# TODO(ssbarnea): Investigate how can we combine c7/c8 in a single job that
# used two nodes. Molecule needs to be able to get the list of nodes to use
# from zuul. If we do this, it should be easier to maintain jobs that need
# to run tests on more than one platform.
- job:
    name: mol-get_hash-centos-7
    parent: mol
    nodeset: rdo-centos-7
    vars:
      mol_scenario: get_hash
    files:
      - .*molecule.*
      - ^ci-scripts/infra-setup/roles/get_hash/.*$
      - ^ci-scripts/infra-setup/roles/promoter/.*$
      - ^requirements.txt
      - ^requirements.txt
      - ^test-requirements.txt
      - ^tox.ini$
      - ^zuul.d/layout.yaml

- job:
    name: mol-get_hash-centos-8
    parent: mol-get_hash-centos-7
    nodeset: rdo-centos-8
