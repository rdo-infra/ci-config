---
- project-template:
    name: jobs-promoter-centos-7-jobs
    check: &jobs
      jobs:
        - tripleo-ci-promotion-staging-single-pipeline-centos-7:
            files: &integration
              - ^ci-scripts/dlrnapi_promoter/.*
              - ^ci-scripts/container-push/.*
              - ^ci-scripts/promote-images.sh
              - ^ci-scripts/infra-setup/roles/promoter/.*
              - ^playbooks/staging.*
              - ^requirements.txt
              - ^test-requirements.txt
        - tripleo-ci-promotion-staging-integration-pipeline-centos-7:
            files: *integration
        - molecule-container-push-delegated-centos-7: &molecule-container-push
            files:
              - ^ci-scripts/dlrnapi_promoter/.*
              - ^ci-scripts/container-push/.*
              - ^ci-scripts/infra-setup/roles/promoter/molecule/container-push/.*
              - ^playbooks/molecule.*.yml
              - ^requirements.txt
              - ^test-requirements.txt
        - molecule-tripleo-common-delegated-centos-7: &molecule-tripleo-common
            files:
              - ^ci-scripts/dlrnapi_promoter/.*
              - ^ci-scripts/container-push/.*
              - ^ci-scripts/infra-setup/roles/promoter/molecule/tripleo-common-integration.*
              - ^playbooks/molecule.*.yml
              - ^requirements.txt
              - ^test-requirements.txt
        - molecule-delegated-promote-images-delegated-centos-7: &molecule-promote-images
            files:
              - ^ci-scripts/dlrnapi_promoter/.*
              - ^ci-scripts/promote-images.sh
              - ^ci-scripts/infra-setup/roles/promoter/molecule/promote-images/.*
              - ^playbooks/molecule.*.yml
              - ^requirements.txt
              - ^test-requirements.txt
    gate: *jobs

- job:
    name: tripleo-ci-promotion-staging-single-pipeline-centos-7
    parent: base
    ansible-version: 2.8
    nodeset: rdo-centos-7
    run: playbooks/staging.yml
    post-run: playbooks/staging-post.yml
    host-vars:
      primary:
        ansible_user: root
    vars:
      pipeline_type: single
      test_release: CentOS-7/master

- job:
    name: tripleo-ci-promotion-staging-integration-pipeline-centos-7
    parent: base
    ansible-version: 2.8
    nodeset: rdo-centos-7
    run: playbooks/staging.yml
    post-run: playbooks/staging-post.yml
    host-vars:
      primary:
        ansible_user: root
    vars:
      pipeline_type: integration
      test_release: CentOS-8/master

# These jobs could be handled by rdo-tox-molecule job, when the pytest-molecule
# supports delegated driver, but as delegated tests don't run in isolation,
# tthey may step on eachother's toe, and the first test could pollute the
# environemnt for the second
# So it's probably better to leave them as standalone jobs
#
- job:
    name: molecule-container-push-delegated-centos-7
    parent: base
    nodeset: rdo-centos-7
    success-url: "tox/reports.html"
    failure-url: "tox/reports.html"
    pre-run: playbooks/molecule-delegated-pre.yml
    run: playbooks/molecule-delegated.yml
    post-run: playbooks/molecule-post.yml
    vars:
      molecule_test_commands: |
        tox -emolecule_delegated -- roles/promoter/molecule/container-push/molecule.yml

- job:
    name: molecule-tripleo-common-delegated-centos-7
    parent: base
    nodeset: rdo-centos-7
    pre-run: playbooks/molecule-delegated-pre.yml
    run: playbooks/molecule-delegated.yml
    post-run: playbooks/molecule-post.yml
    vars:
      molecule_test_commands: |
        # container-push generates staging containers, skip teardown
        molecule converge -s container-push -- --skip-tags=registry_cleanup
        # tripleo-common test w/ staging containers
        molecule test -s tripleo-common-integration
        # container-push teardown, cleanup registries
        molecule converge -s container-push -- --tags=registry_cleanup
      skip_report: true  # old jobs do not produce reports.html

- job:
    name: molecule-delegated-promote-images-delegated-centos-7
    parent: base
    nodeset: rdo-centos-7
    pre-run: playbooks/molecule-delegated-promote-images-pre.yml
    run: playbooks/molecule-delegated.yml
    post-run: playbooks/molecule-post.yml
    vars:
      molecule_test_commands: |
        molecule test -s promote-images
      skip_report: true  # old jobs do not produce reports.html

# Add tox-py-ci-config jobs for use as parent by the corresponding periodics
# https://tree.taiga.io/project/tripleo-ci-board/task/1801
- job:
    name: tox-py27-ci-config
    parent: tox-py27
    pre-run: playbooks/pre-run-docker.yml
    post-run: playbooks/post-run.yml
    success-url: "tox/reports.html"
    failure-url: "tox/reports.html"
    nodeset: rdo-centos-7
    vars:
      tox_environment:
        PYTEST_REQPASS: 188
      zuul_work_dir: "{{ zuul.projects['review.rdoproject.org/rdo-infra/ci-config'].src_dir }}"

- job:
    name: tox-py36-ci-config
    parent: tox-py36
    pre-run: playbooks/pre-run-docker.yml
    post-run: playbooks/post-run.yml
    success-url: "tox/reports.html"
    failure-url: "tox/reports.html"
    vars:
      tox_environment:
        PYTEST_REQPASS: 188
      zuul_work_dir: "{{ zuul.projects['review.rdoproject.org/rdo-infra/ci-config'].src_dir }}"

- job:
    name: rdo-tox-molecule-ci-config
    parent: rdo-tox-molecule
    vars:
      tox_environment:
        PYTEST_REQPASS: 1
      zuul_work_dir: "{{ zuul.projects['review.rdoproject.org/rdo-infra/ci-config'].src_dir }}"


- job:
    name: rdo-tox-molecule-delegated-centos-8-ci-config
    parent: rdo-tox-molecule-delegated-centos-8
    vars:
      tox_environment:
        PYTEST_REQPASS: 1
      zuul_work_dir: "{{ zuul.projects['review.rdoproject.org/rdo-infra/ci-config'].src_dir }}"
